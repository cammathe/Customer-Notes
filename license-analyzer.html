<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NetSuite License Analysis</title>
<style>
    :root {
        --primary: #36677D;
        --primary-dark: #264759;
        --secondary: #86B596;
        --accent: #E2C06B;
        --purple: #9B59B6;
        --blue: #4A90E2;
        --red: #C74634;
        --bg-main: #09090b;
        --bg-dark: #18181b;
        --bg-card: #27272a;
        --bg-light: #3f3f46;
        --bg-white: #52525b;
        --border: #3f3f46;
        --text-dark: #f4f4f5;
        --text-medium: #d4d4d8;
        --text-light: #a1a1aa;
        --spacing-xs: 0.2rem;
        --spacing-sm: 0.3rem;
        --spacing-md: 0.4rem;
        --spacing-lg: 0.6rem;
        --spacing-xl: 0.8rem;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

   body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
    background: var(--bg-main);
    padding: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    color: var(--text-dark);
}

    .scale-container {
    width: 1600px;
    height: 768px;
    transform-origin: top left;
}

    .slide {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        background: var(--bg-main);
        border-radius: 6px;
    }

/* Header Styles */
    .header {
    background: #1F3A4B;
    color: var(--text-dark);
    padding: 0.5rem;
    text-align: center;
    border-radius: 6px 6px 0 0;
}

    .title { font-size: 1.2rem; font-weight: 700; margin-bottom: var(--spacing-xs); color: white; }
    .subtitle { font-size: 0.7rem; margin-bottom: var(--spacing-sm); color: #e5e7eb; }
    .license-info {
        background: rgba(255, 255, 255, 0.15);
        padding: var(--spacing-xs) var(--spacing-lg);
        border-radius: 8px;
        font-size: 0.65rem;
        color: white;
    }

/* Main Content */
    .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: var(--spacing-md);
        background: var(--bg-dark);
        border-radius: 0 0 6px 6px;
    }

/* Controls Section */
    .controls {
        background: var(--bg-card);
        padding: var(--spacing-sm);
        border-radius: 4px;
        margin-bottom: var(--spacing-md);
        position: relative;
        min-height: 35px;
        transition: all 0.3s ease;
        border: 1px solid var(--border);
    }

    .controls.collapsed { max-height: 35px; overflow: hidden; }
    .controls.expanded { max-height: 300px; }
    .always-visible-buttons {
        position: absolute;
        right: var(--spacing-sm);
        top: var(--spacing-md);
        display: flex;
        gap: var(--spacing-xs);
        align-items: center;
        z-index: 20;
    }

    .btn {
        margin: 0;
        padding: 0.25rem 0.6rem;
        border: none;
        border-radius: 3px;
        font-size: 0.6rem;
        cursor: pointer;
        font-weight: 500;
        letter-spacing: 0.3px;
        transition: all 0.2s ease;
    }

    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-danger { background: #C74364; color: white; }
    .btn-danger:hover { background: #B23956; }
    .btn-purple { background: var(--purple); color: white; }
    .btn-purple:hover { opacity: 0.9; }
    .btn-accent { background: var(--accent); color: var(--text-dark); }
    .btn-accent:hover { opacity: 0.9; }
    .btn-success { background: #2C5F2D; color: white; }
    .btn-success:hover { opacity: 0.9; }
    .btn-toggle { background: var(--secondary); color: white; font-size: 0.5rem; }
    .btn-toggle:hover { opacity: 0.9; }

    .input-section {
        margin-top: 2.5rem;
        padding-top: 0.5rem;
    }

    .industry-section {
        margin-top: 0;
        padding: var(--spacing-md);
        border-radius: 4px;
    }

    .industry-title {
        font-size: 0.65rem;
        font-weight: 600;
        color: var(--secondary);
        margin-bottom: var(--spacing-md);
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 0.15rem;
        font-size: 0.6rem;
        cursor: pointer;
        color: var(--text-medium);
    }

    .warning-box {
        margin-top: var(--spacing-lg);
        padding: var(--spacing-md);
        background: #3d3520;
        border: 1px solid #a16207;
        border-radius: 3px;
        font-size: 0.55rem;
        color: var(--accent);
        width: fit-content;
    }

/* Legend */
    .legend-row {
        display: grid;
        grid-template-columns: 1fr 40px 40px;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-xl);
    }

    .legend {
        background: var(--bg-card);
        padding: var(--spacing-md);
        border-radius: 4px;
        text-align: center;
        border: 1px solid var(--border);
    }

    .legend-grid {
        display: flex;
        justify-content: space-around;
        flex-wrap: wrap;
        gap: var(--spacing-sm);
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        font-size: 0.65rem;
        font-weight: 600;
        color: var(--text-medium);
    }

    .legend-color {
        width: 14px;
        height: 14px;
        border-radius: 2px;
        border: 1px solid rgba(255,255,255,0.2);
    }

/* Module States */

     .available { background: var(--bg-light); color: var(--text-medium); border-color: var(--border); }
     .licensed { background: #6BA1B6; color: #1a1a1a; border-color: #6BA1B6; }
     .common { background: var(--secondary); color: #1a1a1a; border-color: var(--secondary); }
     .consideration { background: var(--accent); color: #1a1a1a; border-color: var(--accent); }
     .third-party { background: #606988; color: #1a1a1a; border-color: #606988; }

/* Content Area */
    .content-with-sidebar {
        flex: 1;
        display: grid;
        grid-template-columns: 1fr 40px 40px;
        gap: var(--spacing-md);
        overflow: hidden;
        height: 100%;
        min-height: 0;
    }

    .modules-area {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-lg);
        overflow: hidden;
        height: 100%;
    }

    .modules-row {
        display: grid;
        gap: var(--spacing-md);
    }

    .modules-row.five-columns { grid-template-columns: repeat(5, 1fr); }
    .modules-row.middle-row { grid-template-columns: repeat(5, 1fr); }

    .category {
        border: 1px solid var(--border);
        border-radius: 4px;
        overflow: hidden;
        background: var(--bg-card);
    }

    .category-title {
    background: #1F3A4B;
    color: white;
    padding: var(--spacing-md);
    font-size: 0.85rem;
    font-weight: 700;
    text-align: center;
}

    .modules {
        padding: var(--spacing-sm);
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
    }

    .module {
        padding: var(--spacing-sm);
        border-radius: 3px;
        font-size: 0.6rem;
        font-weight: 600;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
        user-select: none;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .module:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

/* Panels */
    .collapsed-panel {
        background: var(--bg-card);
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        overflow: hidden;
        border: 1px solid var(--border);
        transition: all 0.2s ease;
    }

    .collapsed-panel:hover {
        background: var(--bg-light);
    }

    .collapsed-label {
    writing-mode: vertical-rl;
    text-align: center;
    font-weight: bold;
    font-size: 0.9rem;
    padding: 1rem 0;
}

    .panel-container {
        background: var(--bg-card);
        border-radius: 4px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        height: 100%;
        border: 1px solid var(--border);
    }

    .panel-list {
        overflow-y: auto;
        overflow-x: hidden;
        flex: 1;
        min-height: 0;
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .panel-sticky-header {
        position: sticky;
        top: 0;
        background: var(--bg-card);
        padding: var(--spacing-lg) var(--spacing-lg) 0 var(--spacing-lg);
        z-index: 10;
    }

    .panel-content {
        padding: 0 var(--spacing-lg) var(--spacing-lg) var(--spacing-lg);
        flex: 1;
    }

    .add-button {
    background: #606988;
    color: #1a1a1a;
    border: none;
    padding: var(--spacing-sm);
    border-radius: 4px;
    font-size: 0.6rem;
    cursor: pointer;
    font-weight: normal;
    width: 100%;
    display: block;
    margin-bottom: var(--spacing-sm);
    transition: all 0.2s ease;
}

    .add-button:hover { opacity: 0.9; }
    .add-button.eval { background: var(--accent); color: var(--primary-dark); }

    .box-item {
    background: var(--bg-card);
    border: 1px solid #606988;
    border-radius: 4px;
    padding: var(--spacing-sm);
    margin-bottom: var(--spacing-sm);
}

    .box-item.priority {
    background: var(--bg-card);
    color: var(--primary-dark);
    border: 1px solid var(--accent);
}

.box-item.priority input[type="text"] {
    color: var(--primary-dark);
}

    .box-item input[type="text"] {
        background: var(--bg-light);
        border: 1px solid var(--border);
        color: var(--text-dark);
    }

    .box-item input[type="text"]::placeholder {
        color: var(--text-light);
    }

    .third-party-header {
        background: var(--bg-card);
        border-radius: 4px;
        padding: var(--spacing-xs);
        text-align: center;
        position: relative;
        overflow: hidden;
        border: 1px solid var(--border);
    }

    .column-toggle-btn {
        background: var(--secondary);
        color: white;
        border: none;
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: 3px;
        font-size: 0.5rem;
        cursor: pointer;
        position: absolute;
        right: var(--spacing-sm);
        top: 50%;
        transform: translateY(-50%);
        transition: all 0.2s ease;
    }

    .column-toggle-btn:hover { opacity: 0.9; }

    .logo-container {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
    }

/* Modal */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-container {
        background: var(--bg-dark);
        border-radius: 8px;
        width: 95%;
        height: 95%;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        border: 1px solid var(--border);
    }

    .modal-header {
        background: #1F3A4B;
        color: white;
        padding: 1rem;
        font-size: 1.2rem;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
}

    .modal-close {
        background: none;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0;
        transition: all 0.2s ease;
    }

    .modal-close:hover { opacity: 0.8; }

    .modal-content-wrapper {
        flex: 1;
        overflow: auto;
        position: relative;
        background: var(--bg-main);
    }

    .modal-content {
        padding: 2rem;
        transform-origin: top left;
    }

/* Confirm Dialog */
    .confirm-dialog {
        background: var(--bg-card);
        border-radius: 8px;
        padding: 1.5rem;
        max-width: 400px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        border: 1px solid var(--border);
    }

    .confirm-title {
        font-size: 1.2rem;
        font-weight: bold;
        margin-bottom: 1rem;
    }

    .confirm-message {
        font-size: 0.9rem;
        color: var(--text-medium);
        margin-bottom: 1.5rem;

    }

    .confirm-buttons {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
    }

    .confirm-btn {
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.2s ease;
    }

    .confirm-btn-cancel {
        border: 1px solid var(--border);
        background: var(--bg-light);
        color: var(--text-dark);
    }

    .confirm-btn-cancel:hover {
        background: var(--bg-white);
    }

    .confirm-btn-confirm {
        border: none;
        color: white;
        font-weight: 600;
    }

    .confirm-btn-confirm:hover {
        opacity: 0.9;
    }

/* Scrollbar styling */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: var(--bg-dark);
    }

    ::-webkit-scrollbar-thumb {
        background: var(--bg-light);
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: var(--bg-white);
    }

</style>
</head>
<body>
    <div class="scale-container">
        <div class="slide">
            <div class="header">
                <div class="title" id="customerTitle">NetSuite License Analysis: [Customer Name]</div>
                <div class="subtitle">
                    <strong>Edition:</strong> <span id="edition">[Edition]</span> | 
                    <strong>Service Tier:</strong> <span id="serviceTier">[Service Tier]</span>
                </div>
                <div class="license-info">
                    Full License Users: <span id="licenseCount">[XXX]</span>
                </div>
            </div>

            <div class="main-content">
                <div class="controls collapsed" id="controls">
                    <div class="always-visible-buttons">
                        <button class="btn btn-primary" onclick="app.updateSlide()">Update</button>
                        <button class="btn btn-danger" onclick="app.resetSlide()">Reset</button>
                        <button class="btn btn-purple" onclick="app.showSystemsMap()" style="background: #606988;">Systems Map</button>
                        <button class="btn btn-accent" onclick="app.showCalendar()" style="color: #3f3f46;">Calendar</button>
                        <button class="btn btn-success" onclick="app.exportReport()" style="background: #FF8675;">Export Report</button>
                        <button class="btn btn-toggle" onclick="app.toggleControls()">▼</button>
                    </div>
                    <div class="input-section" id="inputSection" style="display: none;">
    <div class="industry-section">
        <div class="industry-title">Common Industry Templates:</div>
                            <div style="display: flex; flex-direction: row; gap: var(--spacing-lg); flex-wrap: wrap;">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="socialImpact" onchange="app.handleIndustryChange()">
                                    Social Impact
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="services" onchange="app.handleIndustryChange()">
                                    Services
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="healthcare" onchange="app.handleIndustryChange()">
                                    Healthcare
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="international" onchange="app.handleIndustryChange()">
                                    International
                                </label>
                            </div>
                            <div class="warning-box">
                                Note: Click "Update" after making industry template selections to ensure customer licensing and current opportunities are accurately highlighted.
                            </div>
                        </div>
                    </div>
                </div>

                <div class="legend-row" id="legendRow">
                    <div class="legend">
                        <div class="legend-grid">
                            <div class="legend-item">
                                <div class="legend-color available"></div>
                                Available Module
                            </div>
                            <div class="legend-item">
                                <div class="legend-color licensed"></div>
                                Currently Licensed
                            </div>
                            <div class="legend-item">
                                <div class="legend-color common"></div>
                                Common for Industry
                            </div>
                            <div class="legend-item">
                                <div class="legend-color consideration"></div>
                                Evaluating
                            </div>
                            <div class="legend-item">
                                <div class="legend-color third-party"></div>
                                3rd Party Solution
                            </div>
                        </div>
                    </div>

                    <div class="third-party-header" id="thirdPartyHeader">
    <button class="column-toggle-btn" style="background: #606988;" onclick="app.toggleThirdParty()">▼</button>
</div>

<div class="third-party-header" id="evaluationHeader">
    <button class="column-toggle-btn" style="background: var(--accent); color: #3f3f46;" onclick="app.toggleEvaluation()">▼</button>
</div>
                </div>

                <div class="content-with-sidebar" id="contentArea">
                    <div class="modules-area" id="modulesArea">
                        <div class="modules-row five-columns">
                            <div class="category">
                                <div class="category-title">CRM + Marketing</div>
                                <div class="modules">
                                    <div class="module licensed" onclick="app.cycle(this)">CRM</div>
                                    <div class="module available" onclick="app.cycle(this)">Compliance360</div>
                                    <div class="module available" onclick="app.cycle(this)">Outlook Connector</div>
                                    <div class="module available" onclick="app.cycle(this)">Salesforce Connector</div>
                                </div>
                            </div>

                            <div class="category">
                                <div class="category-title">Procurement</div>
                                <div class="modules">
                                    <div class="module available" onclick="app.cycle(this)">Bill Capture</div>
                                    <div class="module available" onclick="app.cycle(this)">Advanced Electronic Bank Payments</div>
                                    <div class="module available" onclick="app.cycle(this)">Intelligent Payment Automation</div>
                                    <div class="module available" onclick="app.cycle(this)">Procurement</div>
                                    <div class="module available" onclick="app.cycle(this)">SuiteProcurement</div>
                                    <div class="module available" onclick="app.cycle(this)">Fixed Assets Management</div>
                                </div>
                            </div>

                            <div class="category">
                                <div class="category-title">Accounting</div>
                                <div class="modules">
                                    <div class="module available" onclick="app.cycle(this)">Account Reconciliation</div>
                                    <div class="module available" onclick="app.cycle(this)">Advanced Financials</div>
                                    <div class="module available" onclick="app.cycle(this)">Close Management</div>
                                    <div class="module available" onclick="app.cycle(this)">Multi-Book</div>
                                    <div class="module available" onclick="app.cycle(this)">OneWorld</div>
                                    <div class="module available" onclick="app.cycle(this)">SuiteTax</div>
                                </div>
                            </div>

                            <div class="category">
                                <div class="category-title">Revenue</div>
                                <div class="modules">
                                    <div class="module available" onclick="app.cycle(this)">Contract Renewals</div>
                                    <div class="module available" onclick="app.cycle(this)">Rebate Management</div>
                                    <div class="module available" onclick="app.cycle(this)">Revenue Management</div>
                                    <div class="module available" onclick="app.cycle(this)">Revenue Allocations</div>
                                </div>
                            </div>

                            <div class="category">
                                <div class="category-title">Payment Processing</div>
                                <div class="modules">
                                    <div class="module available" onclick="app.cycle(this)">Dunning</div>
                                    <div class="module available" onclick="app.cycle(this)">e-invoicing</div>
                                    <div class="module available" onclick="app.cycle(this)">NetSuite Pay</div>
                                    <div class="module available" onclick="app.cycle(this)">SuiteBilling</div>
                                    <div class="module available" onclick="app.cycle(this)">SuitePayments</div>
                                </div>
                            </div>
                        </div>

                        <div class="modules-row middle-row">
                            <div class="category">
                                <div class="category-title">Project Management</div>
                                <div class="modules">
                                    <div class="module available" onclick="app.cycle(this)">Project Management</div>
                                    <div class="module available" onclick="app.cycle(this)">SuiteProjects</div>
                                    <div class="module available" onclick="app.cycle(this)">SuiteProjects Pro</div>
                                    <div class="module available" onclick="app.cycle(this)">Field Service Management</div>
                                </div>
                            </div>

                            <div class="logo-container" style="grid-column: 2 / 5;">
    <img src="./netsuite-logo.png" alt="NetSuite Logo" style="max-height: 120px; max-width: 500px; object-fit: contain;">
</div>

                            <div class="category">
                                <div class="category-title">Analytics</div>
                                <div class="modules">
                                    <div class="module available" onclick="app.cycle(this)">Corporate Tax</div>
                                    <div class="module available" onclick="app.cycle(this)">Narrative Reporting</div>
                                    <div class="module available" onclick="app.cycle(this)">Planning + Budgeting</div>
                                    <div class="module available" onclick="app.cycle(this)">Analytics Warehouse</div>
                                    <div class="module available" onclick="app.cycle(this)">SuiteAnalytics Connect</div>
                                    <div class="module licensed" onclick="app.cycle(this)">SuiteAnalytics Workbooks</div>
                                </div>
                            </div>
                        </div>

                        <div class="modules-row five-columns">
                            <div class="category">
                                <div class="category-title">eCommerce</div>
                                <div class="modules">
                                    <div class="module available" onclick="app.cycle(this)">eCommerce Connector</div>
                                    <div class="module available" onclick="app.cycle(this)">POS Connector</div>
                                    <div class="module available" onclick="app.cycle(this)">SuiteCommerce</div>
                                    <div class="module available" onclick="app.cycle(this)">SuiteCommerce Advanced</div>
                                    <div class="module available" onclick="app.cycle(this)">SuiteCommerce InStore</div>
                                    <div class="module available" onclick="app.cycle(this)">Connector</div>
                                </div>
                            </div>

                            <div class="category">
                                <div class="category-title">Inventory</div>
                                <div class="modules">
                                    <div class="module available" onclick="app.cycle(this)">Inventory Management</div>
                                    <div class="module available" onclick="app.cycle(this)">Order Management</div>
                                    <div class="module available" onclick="app.cycle(this)">Grid Order Management</div>
                                    <div class="module available" onclick="app.cycle(this)">Warehouse Management</div>
                                    <div class="module available" onclick="app.cycle(this)">Smart Count</div>
                                    <div class="module available" onclick="app.cycle(this)">Logistics Connector</div>
                                </div>
                            </div>

                            <div class="category">
                                <div class="category-title">Manufacturing</div>
                                <div class="modules">
                                    <div class="module available" onclick="app.cycle(this)">Advanced Manufacturing</div>
                                    <div class="module available" onclick="app.cycle(this)">CPQ</div>
                                    <div class="module available" onclick="app.cycle(this)">Demand Planning</div>
                                    <div class="module available" onclick="app.cycle(this)">Quality Management</div>
                                    <div class="module available" onclick="app.cycle(this)">WIP + Routings</div>
                                    <div class="module available" onclick="app.cycle(this)">Work Orders</div>
                                </div>
                            </div>

                            <div class="category">
                                <div class="category-title">HRIS</div>
                                <div class="modules">
                                    <div class="module available" onclick="app.cycle(this)">SuitePeople HR</div>
                                    <div class="module available" onclick="app.cycle(this)">Incentive Compensation</div>
                                    <div class="module available" onclick="app.cycle(this)">Payroll</div>
                                    <div class="module available" onclick="app.cycle(this)">Performance Management</div>
                                    <div class="module available" onclick="app.cycle(this)">Workforce Management</div>
                                </div>
                            </div>

                            <div class="category">
                                <div class="category-title">Infrastructure</div>
                                <div class="modules">
                                    <div class="module available" onclick="app.cycle(this)">ACS</div>
                                    <div class="module available" onclick="app.cycle(this)">AI Consulting</div>
                                    <div class="module available" onclick="app.cycle(this)">Disaster Recovery</div>
                                    <div class="module available" onclick="app.cycle(this)">LCS</div>
                                    <div class="module available" onclick="app.cycle(this)">Support - Premium</div>
                                    <div class="module available" onclick="app.cycle(this)">NSIP</div>
                                    <div class="module available" onclick="app.cycle(this)">Sandbox</div>
                                    <div class="module available" onclick="app.cycle(this)">SuiteCloud+</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="collapsed-panel" id="thirdPartyPanel" onclick="app.toggleThirdParty()">
    <div class="collapsed-label" style="color: #606988;">3rd Party Solutions</div>
</div>

<div class="collapsed-panel" id="evaluationPanel" onclick="app.toggleEvaluation()">
    <div class="collapsed-label" style="color: var(--accent);">Evaluation Priorities</div>
</div>
                </div>
            </div>
        </div>
    </div>

    <script>
// Application State
        const app = {
            state: {
    thirdPartySolutions: {},
    customSolutions: [],
    allEvaluationPriorities: [],
    thirdPartyExpanded: false,
    evaluationExpanded: false,
    originalCustomerData: null
},

// Module cycling
            cycle(element) {
    const states = ['available', 'common', 'consideration', 'third-party'];

// Prevent clicking on licensed modules
if (element.classList.contains('licensed')) {
    return;
}
    const currentIndex = states.findIndex(state => element.classList.contains(state));
    const moduleName = element.textContent.trim();

// Prevent changing licensed modules
if (element.classList.contains('licensed')) {
    const self = this;
    this.createConfirmModal(
        'Cannot Modify',
        '"' + moduleName + '" is currently licensed and cannot be changed in this view.',
        'OK',
        '#36677D',
        function() {

// Just close - do nothing
        },
        '#36677D'
    );
    return;
}

// Check if cycling away from licensed - require confirmation
    if (states[currentIndex] === 'licensed') {
        this.createConfirmModal(
            'Warning',
            `"${moduleName}" is currently licensed. Are you sure you want to change its status?`,
            'Change Status',
            'var(--red)',
            () => {
                // If cycling away from third-party, clean up the data
                if (states[currentIndex] === 'third-party') {
                    delete this.state.thirdPartySolutions[moduleName];
                    delete this.state.thirdPartySolutions[moduleName + '_integrated'];
                    delete this.state.thirdPartySolutions[moduleName + '_manual'];
                }         
                element.classList.remove(states[currentIndex]);
                element.classList.add(states[(currentIndex + 1) % states.length]);
                this.updatePanels();
                this.saveState();
                this.sendThirdPartyUpdate();
                this.sendEvaluationUpdate(); 
                this.updateCalendar();
                this.sendModuleStateUpdate();
            },
            'var(--red)'
        );
        return;
    }

// If cycling away from third-party, clean up the data
    if (states[currentIndex] === 'third-party') {
        delete this.state.thirdPartySolutions[moduleName];
        delete this.state.thirdPartySolutions[moduleName + '_integrated'];
        delete this.state.thirdPartySolutions[moduleName + '_manual'];
    }

    element.classList.remove(states[currentIndex]);
    element.classList.add(states[(currentIndex + 1) % states.length]);
    this.updatePanels();
    this.saveState();
    this.sendThirdPartyUpdate();
    this.sendEvaluationUpdate(); 
    this.sendModuleStateUpdate();

// Always update calendar when toggling, regardless of expansion state
        this.updateCalendar();
},

            updatePanels() {
                setTimeout(() => {
                    if (document.getElementById('evaluationList')) this.updateEvaluationPanel();
                    if (document.getElementById('thirdPartyList')) this.updateThirdPartyPanel();
                    this.saveState();
                }, 10);
            },
saveState() {
    if (!this.state.originalCustomerData) return;

    const stateToSave = {
        customerName: this.state.originalCustomerData.customerName,
        thirdPartySolutions: this.state.thirdPartySolutions,
        customSolutions: this.state.customSolutions,
        allEvaluationPriorities: this.state.allEvaluationPriorities,
        industryTemplates: {
            socialImpact: document.getElementById('socialImpact')?.checked || false,
            services: document.getElementById('services')?.checked || false,
            healthcare: document.getElementById('healthcare')?.checked || false,
            international: document.getElementById('international')?.checked || false
        },
        moduleStates: {}
    };

// Save all module states
    stateToSave.moduleStates = {};
    document.querySelectorAll('.module').forEach(module => {
        const name = module.textContent.trim();
        const state = Array.from(module.classList).find(c => 
            ['available', 'licensed', 'common', 'consideration', 'third-party'].includes(c)
        );
        if (state) {
            stateToSave.moduleStates[name] = state;
        }
    });

    localStorage.setItem('licenseAnalyzerState_' + this.state.originalCustomerData.customerName, JSON.stringify(stateToSave));
    console.log('State saved, thirdPartySolutions:', this.state.thirdPartySolutions);
},

// Grid management
            setGrid() {
    const grid = !this.state.thirdPartyExpanded && !this.state.evaluationExpanded ? '1fr 40px 40px' :
                 this.state.thirdPartyExpanded && !this.state.evaluationExpanded ? '1fr 240px 40px' :
                 !this.state.thirdPartyExpanded && this.state.evaluationExpanded ? '1fr 40px 240px' :
                 '1fr 240px 240px';

    document.getElementById('contentArea').style.gridTemplateColumns = grid;
    document.getElementById('legendRow').style.gridTemplateColumns = grid;
},

// Toggle panels
            toggleThirdParty() {
                this.state.thirdPartyExpanded = !this.state.thirdPartyExpanded;
                const panel = document.getElementById('thirdPartyPanel');
                const header = document.getElementById('thirdPartyHeader');

                if (this.state.thirdPartyExpanded) {
                    panel.onclick = null;
                    panel.className = 'panel-container';
                    panel.innerHTML = `
                        <div class="panel-list" id="thirdPartyList">
                            <div class="panel-sticky-header">
                                <button class="add-button" onclick="app.addCustomSolution()">+ 3rd Party Solution</button>
                            </div>
                            <div class="panel-content" id="thirdPartyContent"></div>
                        </div>
                    `;
                    header.innerHTML = `
    <div style="font-size: 0.8rem; font-weight: 700; color: #606988;">3rd Party Solutions</div>
    <button class="column-toggle-btn" style="background: #606988;" onclick="app.toggleThirdParty()">▲</button>
`;
                    header.style.padding = 'var(--spacing-md)';
                    this.updateThirdPartyPanel();
                } else {
                    panel.onclick = () => this.toggleThirdParty();
                    panel.className = 'collapsed-panel';
                    panel.innerHTML = '<div class="collapsed-label" style="color: #606988;">3rd Party Solutions</div>';
                    header.innerHTML = '<button class="column-toggle-btn" style="background: #606988;" onclick="app.toggleThirdParty()">▼</button>';
                    header.style.padding = 'var(--spacing-xs)';
                }
                this.setGrid();
                setTimeout(() => this.matchPanelHeights(), 50);
            },

            toggleEvaluation() {
                this.state.evaluationExpanded = !this.state.evaluationExpanded;
                const panel = document.getElementById('evaluationPanel');
                const header = document.getElementById('evaluationHeader');

                if (this.state.evaluationExpanded) {
                    panel.onclick = null;
                    panel.className = 'panel-container';
                    panel.innerHTML = `
                        <div class="panel-list" id="evaluationList">
                            <div class="panel-sticky-header">
                                <button class="add-button eval" onclick="app.addEvaluationPriority()">+ Evaluation Priority</button>
                            </div>
                            <div class="panel-content" id="evaluationContent"></div>
                        </div>
                    `;
                    header.innerHTML = `
    <div style="font-size: 0.8rem; font-weight: 700; color: var(--accent);">Evaluation Priorities</div>
    <button class="column-toggle-btn" style="background: var(--accent); color: #3f3f46;" onclick="app.toggleEvaluation()">▼</button>
`;
                    header.style.padding = 'var(--spacing-md)';
                    this.updateEvaluationPanel();
                } else {
                    panel.onclick = () => this.toggleEvaluation();
                    panel.className = 'collapsed-panel';
                    panel.innerHTML = '<div class="collapsed-label" style="color: var(--accent);">Evaluation Priorities</div>';
                    header.innerHTML = '<button class="column-toggle-btn" style="background: var(--accent); color: #3f3f46;" onclick="app.toggleEvaluation()">▲</button>';
                    header.style.padding = 'var(--spacing-xs)';
                }
                this.setGrid();
                setTimeout(() => this.matchPanelHeights(), 50);
            },

            toggleControls() {
                const controls = document.getElementById('controls');
                const inputSection = document.getElementById('inputSection');
                const btn = document.querySelector('.btn-toggle');
                

                if (controls.classList.contains('collapsed')) {
                    controls.classList.replace('collapsed', 'expanded');
                    inputSection.style.display = 'block';
                    btn.textContent = '▲';
                } else {
                    controls.classList.replace('expanded', 'collapsed');
                    inputSection.style.display = 'none';
                    btn.textContent = '▼';
                }
            },

// Panel updates
            updateEvaluationPanel() {
                const content = document.getElementById('evaluationContent');
                if (!content) return;

                const evaluationModules = Array.from(document.querySelectorAll('.module.consideration'))
                    .map(m => m.textContent.trim());

                this.state.allEvaluationPriorities = this.state.allEvaluationPriorities
                    .filter(p => p.type === 'custom' || evaluationModules.includes(p.name));               

                evaluationModules.forEach(module => {
                    if (!this.state.allEvaluationPriorities.find(p => p.type === 'module' && p.name === module)) {
                        this.state.allEvaluationPriorities.push({ type: 'module', name: module });
                    }
                });
                if (this.state.allEvaluationPriorities.length === 0) {
                    content.innerHTML = '<div style="text-align: center; color: #999; font-size: 0.65rem; font-style: italic; padding: 1.5rem; background: var(--bg-light); border-radius: 4px; border: 1px solid var(--border);">Mark modules as "Evaluating" or add custom priorities here.</div>';
                    return;
                }

                content.innerHTML = this.state.allEvaluationPriorities.map((priority, index) => this.renderPriorityItem(priority, index)).join('');
this.saveState();
    this.sendEvaluationUpdate();
            },

            renderPriorityItem(priority, index) {
    const isCustom = priority.type === 'custom';
    const titleContent = isCustom 
? `<input type="text" style="background: var(--bg-light); border: 1px solid var(--border); font-size: 0.6rem; font-weight: 600; color: var(--text-medium); font-family: inherit; padding: var(--spacing-sm); outline: none; flex: 1; min-width: 0; border-radius: 3px;" placeholder="Enter evaluation priority..." value="${priority.name || ''}" onchange="app.state.allEvaluationPriorities[${index}].name = this.value.trim(); app.saveState();">`
: `<span style="font-size: 0.6rem; font-weight: 600; color: var(--text-medium);">${priority.name}</span>`;

    const removeBtn = isCustom 
? `<button onclick="app.removeEvaluationPriority(${index})" style="background: transparent; color: #C74364; border: none; padding: 0; margin-left: 0.5rem; cursor: pointer;">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="3 6 5 6 21 6"></polyline>
      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
      <line x1="10" y1="11" x2="10" y2="17"></line>
      <line x1="14" y1="11" x2="14" y2="17"></line>
    </svg>
  </button>`
: '';

                const upBtn = index > 0 
    ? `<button onclick="app.movePriority(${index}, ${index - 1})" style="background: none; color: var(--bg-light); border: none; padding: 0; cursor: pointer; font-size: 8px;">▲</button>`
    : '';

const downBtn = index < this.state.allEvaluationPriorities.length - 1
    ? `<button onclick="app.movePriority(${index}, ${index + 1})" style="background: none; color: var(--bg-light); border: none; padding: 0; cursor: pointer; font-size: 8px;">▼</button>`
    : '';

                return `
                    <div class="box-item priority">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <div style="display: flex; align-items: center; flex: 1; min-width: 0;">
                                <span style="background: var(--accent); color: var(--primary-dark); border-radius: 50%; width: 22px; height: 22px; line-height: 22px; font-size: 0.65rem; text-align: center; margin-right: var(--spacing-md); font-weight: bold; flex-shrink: 0;">${index + 1}</span>
                                ${titleContent}
                            </div>
                            <div style="display: flex; align-items: center; gap: 4px; flex-shrink: 0;">
                                ${removeBtn}
                                <div style="display: flex; flex-direction: column; gap: 2px;">${upBtn}${downBtn}</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: var(--spacing-sm); font-size: 0.55rem; margin-left: 26px; flex-wrap: wrap;">
    ${['ASAP', '3mo.', '3-6mo.', '6mo+'].map(label => `
<label style="display: flex; align-items: center; gap: 2px; cursor: pointer; color: var(--text-medium);">
        <input type="radio" name="timeline_${index}" value="${label}" ${priority.timeline === label ? 'checked' : ''} onchange="app.state.allEvaluationPriorities[${index}].timeline = '${label}'; app.saveState();" style="width: 12px; height: 12px; cursor: pointer; margin: 0;">
        <span style="font-size: 0.55rem; user-select: none;">${label}</span>
    </label>
                            `).join('')}
                        </div>
                    </div>
                `;
            },

            movePriority(from, to) {
    const [item] = this.state.allEvaluationPriorities.splice(from, 1);
    this.state.allEvaluationPriorities.splice(to, 0, item);
    this.updateEvaluationPanel();
    this.saveState();
},

            addEvaluationPriority() {
    this.state.allEvaluationPriorities.push({type: 'custom', name: ''});
    this.updateEvaluationPanel();
    this.saveState();
    this.sendEvaluationUpdate();
},

removeEvaluationPriority(index) {
    this.state.allEvaluationPriorities.splice(index, 1);
    this.updateEvaluationPanel();
    this.saveState();
    this.sendEvaluationUpdate();
},

sendModuleStateUpdate() {
    if (window.parent && window.parent !== window) {
        const moduleStates = {};
       
        document.querySelectorAll('.module').forEach(module => {
            const name = module.textContent.trim();
            const state = Array.from(module.classList).find(c => 
                ['available', 'licensed', 'common', 'consideration', 'third-party'].includes(c)
            );
            if (state && state !== 'available' && state !== 'licensed') {
                moduleStates[name] = state;
            }
        });

        window.parent.postMessage({
            type: 'MODULE_STATE_UPDATE',
            customerName: this.state.originalCustomerData?.customerName || '',
            moduleStates: moduleStates
        }, '*');

        console.log('Sent module state update:', moduleStates);
    }
},

            updateThirdPartyPanel() {
                const content = document.getElementById('thirdPartyContent');
                if (!content) return;

                const thirdPartyModules = document.querySelectorAll('.module.third-party');
                const items = [];

                thirdPartyModules.forEach(module => {
                    const moduleName = module.textContent.trim();
                    items.push(this.renderThirdPartyItem(moduleName, false));
                });

                this.state.customSolutions.forEach((solution, index) => {
                    items.push(this.renderThirdPartyItem(solution, true, index));
                });

                if (items.length === 0) {
                    content.innerHTML = '<div style="text-align: center; color: #999; font-size: 0.6rem; font-style: italic; padding: 1.5rem; background: var(--bg-light); border-radius: 4px; border: 1px solid var(--border);">Mark modules as "3rd Party Solution" or add custom solutions here</div>';
                } else {
                    content.innerHTML = items.join('');
                }
 this.saveState(); 
            },
sendThirdPartyUpdate() {
    if (window.parent && window.parent !== window) {
      const allSolutions = [];

// Add modules marked as third-party
      document.querySelectorAll('.module.third-party').forEach(module => {
        const moduleName = module.textContent.trim();
        const solutionName = this.state.thirdPartySolutions[moduleName] || '';
        const hasIntegrated = this.state.thirdPartySolutions[moduleName + '_integrated'];
        const hasManual = this.state.thirdPartySolutions[moduleName + '_manual'];

// Parse connector name from parentheses
        let cleanSolutionName = solutionName;
        let connectorName = '';
        const parenMatch = solutionName.match(/^(.+?)\s*\((.+?)\)\s*$/);
        if (parenMatch) {
          cleanSolutionName = parenMatch[1].trim();
          connectorName = parenMatch[2].trim();
        }

        allSolutions.push({
          purpose: moduleName,
          solutionName: cleanSolutionName,
          connectedToNS: hasIntegrated && hasManual ? 'both' : 
                         hasIntegrated ? 'integrated' : 
                         hasManual ? 'manual' : 'disconnected',
          connectorName: connectorName
        });
      });  

// Add custom solutions
      this.state.customSolutions.forEach(sol => {
      // Parse connector name from parentheses
        let cleanSolutionName = sol.name || '';
        let connectorName = '';
        const parenMatch = cleanSolutionName.match(/^(.+?)\s*\((.+?)\)\s*$/);
        if (parenMatch) {
          cleanSolutionName = parenMatch[1].trim();
          connectorName = parenMatch[2].trim();
        }

        allSolutions.push({
          purpose: sol.title || '',
          solutionName: cleanSolutionName,
          connectedToNS: sol.integrated && sol.manual ? 'both' : 
                         sol.integrated ? 'integrated' : 
                         sol.manual ? 'manual' : 'disconnected',
          connectorName: connectorName
        });
      });
   
      window.parent.postMessage({
        type: 'THIRD_PARTY_UPDATE',
        customerName: this.state.originalCustomerData?.customerName || '',
        customSolutions: allSolutions
      }, '*');
    }
  },

sendEvaluationUpdate() {
    if (window.parent && window.parent !== window) {
        const evaluationModules = [];
        
// Get modules marked as consideration
        document.querySelectorAll('.module.consideration').forEach(module => {
            const moduleName = module.textContent.trim();
            // Find the process area for this module
            const categoryDiv = module.closest('.category');
            const processArea = categoryDiv?.querySelector('.category-title')?.textContent.trim() || 'Uncategorized';
            evaluationModules.push({ name: moduleName, processArea: processArea });
        });

// Get custom evaluation priorities
        const customPriorities = this.state.allEvaluationPriorities
            .filter(p => p.type === 'custom' && p.name)
            .map(p => ({ name: p.name, processArea: 'Custom' }));

        const allEvaluations = [...evaluationModules, ...customPriorities];

        window.parent.postMessage({
            type: 'EVALUATION_UPDATE',
            customerName: this.state.originalCustomerData?.customerName || '',
            evaluations: allEvaluations
        }, '*');
       
        console.log('Sent evaluation update:', allEvaluations);
    }
},

            renderThirdPartyItem(data, isCustom, index) {
                const moduleName = isCustom ? data.title : data;
                const solutionKey = isCustom ? 'name' : moduleName;
                const integratedKey = isCustom ? 'integrated' : `${moduleName}_integrated`;
                const manualKey = isCustom ? 'manual' : `${moduleName}_manual`;              

                const titleInput = isCustom 
    ? `<input type="text" placeholder="Category Title (ex. CRM, Accounting)" value="${data.title || ''}" onchange="app.state.customSolutions[${index}].title = this.value; app.sendThirdPartyUpdate();" style="flex: 1; padding: var(--spacing-sm); border: 1px solid var(--border); border-radius: 3px; font-size: 0.6rem; font-weight: 600; color: var(--text-medium); background: var(--bg-light); font-family: inherit;">`
    : `<div style="font-size: 0.6rem; font-weight: 600; color: var(--text-medium); margin-bottom: 0.5rem;">${moduleName}</div>`;

                const removeBtn = isCustom 
    ? `<button onclick="app.state.customSolutions.splice(${index}, 1); app.updateThirdPartyPanel();" style="background: transparent; color: #C74364; border: none; padding: 0; margin-left: 0.5rem; cursor: pointer;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="3 6 5 6 21 6"></polyline>
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          <line x1="10" y1="11" x2="10" y2="17"></line>
          <line x1="14" y1="11" x2="14" y2="17"></line>
        </svg>
      </button>`
    : '';

                const solutionValue = isCustom ? (data.name || '') : (this.state.thirdPartySolutions[moduleName] || '');
                const integratedChecked = isCustom ? data.integrated : this.state.thirdPartySolutions[integratedKey];
                const manualChecked = isCustom ? data.manual : this.state.thirdPartySolutions[manualKey];

                const onSolutionChange = isCustom 
    ? `app.state.customSolutions[${index}].name = this.value; app.sendThirdPartyUpdate(); setTimeout(() => app.saveState(), 50);`
    : `app.state.thirdPartySolutions['${moduleName}'] = this.value.trim() || undefined; app.sendThirdPartyUpdate(); setTimeout(() => app.saveState(), 50);`;

const onIntegratedChange = isCustom
    ? `app.state.customSolutions[${index}].integrated = this.checked; app.sendThirdPartyUpdate(); setTimeout(() => app.saveState(), 50);`
    : `app.state.thirdPartySolutions['${integratedKey}'] = this.checked; console.log('Set integrated:', this.checked, '${integratedKey}'); app.sendThirdPartyUpdate(); setTimeout(() => app.saveState(), 50);`;

const onManualChange = isCustom
    ? `app.state.customSolutions[${index}].manual = this.checked; app.sendThirdPartyUpdate(); setTimeout(() => app.saveState(), 50);`
    : `app.state.thirdPartySolutions['${manualKey}'] = this.checked; console.log('Set manual:', this.checked, '${manualKey}'); app.sendThirdPartyUpdate(); setTimeout(() => app.saveState(), 50);`;

                return `
    <div class="box-item" style="background: var(--bg-card);">
                        ${isCustom ? `<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">${titleInput}${removeBtn}</div>` : titleInput}
                        <input type="text" placeholder="Solution Name (Connector Name, if applicable)" value="${solutionValue}" onchange="${onSolutionChange}; app.saveState();" style="width: 100%; padding: var(--spacing-sm); border: 1px solid var(--border); border-radius: 3px; font-size: 0.6rem; font-weight: 600; color: var(--text-medium); background: var(--bg-light); font-family: inherit; margin-bottom: 0.5rem;">
                        <div style="display: flex; gap: 1rem; font-size: 0.55rem; color: var(--text-light);">
    <label style="display: flex; align-items: center; gap: var(--spacing-md); cursor: pointer;">
        <input type="checkbox" ${integratedChecked ? 'checked' : ''} onchange="${onIntegratedChange}" style="width: 12px; height: 12px; cursor: pointer;">
        <span style="cursor: pointer; user-select: none;">Integrated w/NS</span>
    </label>
    <label style="display: flex; align-items: center; gap: var(--spacing-md); cursor: pointer;">
        <input type="checkbox" ${manualChecked ? 'checked' : ''} onchange="${onManualChange}" style="width: 12px; height: 12px; cursor: pointer;">
        <span style="cursor: pointer; user-select: none;">Manual Data Transfer</span>
    </label>
</div>
                    </div>
                `;
            },

            addCustomSolution() {
    this.state.customSolutions.push({title: '', name: '', integrated: false, manual: false});
    this.updateThirdPartyPanel();
    this.sendThirdPartyUpdate();
},

            matchPanelHeights() {
                const modulesHeight = document.getElementById('modulesArea')?.offsetHeight;
                if (!modulesHeight) return;

                ['thirdPartyPanel', 'evaluationPanel'].forEach(id => {
                    const panel = document.getElementById(id);
                    const isExpanded = id === 'thirdPartyPanel' ? this.state.thirdPartyExpanded : this.state.evaluationExpanded;
                    if (panel && isExpanded) {
                        panel.style.height = panel.style.minHeight = panel.style.maxHeight = `${modulesHeight}px`;
                    }
                });
            },

// Industry templates
            handleIndustryChange() {
                const templates = {
                    socialImpact: ['Bill Capture', 'Advanced Electronic Bank Payments', 'Intelligent Payment Automation', 'Fixed Assets Management', 'Advanced Financials', 'Revenue Management', 'Project Management', 'Planning + Budgeting', 'Analytics Warehouse', 'SuiteAnalytics Connect', 'ACS', 'LCS', 'Support - Premium', 'Sandbox'],
                    services: ['Bill Capture', 'Advanced Electronic Bank Payments', 'Intelligent Payment Automation', 'Procurement', 'Fixed Assets Management', 'Advanced Financials', 'Revenue Management', 'Planning + Budgeting', 'Analytics Warehouse', 'SuiteAnalytics Connect', 'ACS', 'LCS', 'Support - Premium', 'Sandbox', 'SuiteCommerce', 'SuiteBilling', 'Dunning', 'SuiteProjects'],
                    healthcare: ['Bill Capture', 'Advanced Electronic Bank Payments', 'Intelligent Payment Automation', 'Procurement', 'Fixed Assets Management', 'Advanced Financials', 'Revenue Management', 'Project Management', 'Planning + Budgeting', 'Analytics Warehouse', 'SuiteAnalytics Connect', 'ACS', 'LCS', 'Support - Premium', 'Sandbox', 'Compliance360', 'Dunning', 'Inventory Management'],
                    international: ['Advanced Electronic Bank Payments', 'Fixed Assets Management', 'Advanced Financials', 'Project Management', 'Planning + Budgeting', 'Analytics Warehouse', 'SuiteAnalytics Connect', 'ACS', 'LCS', 'Support - Premium', 'Sandbox', 'e-invoicing', 'OneWorld']
                };

// Reset all modules
                document.querySelectorAll('.module').forEach(m => m.className = 'module available');

// Restore customer header information if it exists
if (this.state.originalCustomerData) {
    document.getElementById('customerTitle').textContent = `NetSuite License Analysis: ${this.state.originalCustomerData.customerName}`;
    document.getElementById('edition').textContent = this.state.originalCustomerData.edition;
    document.getElementById('serviceTier').textContent = this.state.originalCustomerData.serviceTier;
    document.getElementById('licenseCount').textContent = this.state.originalCustomerData.users;
}

// Set licensed modules
                ['CRM', 'SuiteAnalytics Workbooks'].forEach(name => {
                    document.querySelectorAll('.module').forEach(m => {
                        if (m.textContent.trim() === name) m.className = 'module licensed';
                    });
                });

// Apply industry templates
                const selected = new Set();
                ['socialImpact', 'services', 'healthcare', 'international'].forEach(industry => {
                    if (document.getElementById(industry)?.checked) {
                        templates[industry].forEach(mod => selected.add(mod));
                    }
                });

                selected.forEach(moduleName => {
                    document.querySelectorAll('.module').forEach(m => {
                        const text = m.textContent.trim();
                        if (text === moduleName && !['CRM', 'SuiteAnalytics Workbooks'].includes(text)) {
                            m.className = 'module common';
                        }
                    });
                });

                this.updatePanels();
            },

// Modal utilities
            createModal(title, contentHtml, width = '95%', height = '95%') {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-container" style="width: ${width}; height: ${height};">
                        <div class="modal-header">
                            <span>${title}</span>
                            <button class="modal-close">Ã—</button>
                        </div>
                        <div class="modal-content-wrapper">
                            <div class="modal-content">${contentHtml}</div>
                        </div>
                    </div>
                `;

                const close = () => modal.remove();
                modal.querySelector('.modal-close').onclick = close;
                modal.addEventListener('click', e => { if (e.target === modal) close(); });         

                document.body.appendChild(modal);            

                const content = modal.querySelector('.modal-content');
                const wrapper = modal.querySelector('.modal-content-wrapper');
                setTimeout(() => this.scaleContentToFit(content, wrapper), 50);
                
                const resizeHandler = () => this.scaleContentToFit(content, wrapper);
                window.addEventListener('resize', resizeHandler);
               
                const originalRemove = modal.remove.bind(modal);
                modal.remove = function() {
                    window.removeEventListener('resize', resizeHandler);
                    originalRemove();
                };

                return modal;
            },

            createConfirmModal(title, message, confirmText, confirmColor, onConfirm, titleColor = '#C74364') {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="confirm-dialog">
                        <div class="confirm-title" style="color: ${titleColor};">${title}</div>
                        <div class="confirm-message">${message}</div>
                        <div class="confirm-buttons">
                            <button class="confirm-btn confirm-btn-cancel">Cancel</button>
                            <button class="confirm-btn confirm-btn-confirm" style="background: ${confirmColor};">${confirmText}</button>
                        </div>
                    </div>
                `;

                const close = () => modal.remove();
                modal.querySelector('.confirm-btn-cancel').onclick = close;
                modal.querySelector('.confirm-btn-confirm').onclick = () => { onConfirm(); close(); };
                modal.addEventListener('click', e => { if (e.target === modal) close(); });            

                document.body.appendChild(modal);
            },

            scaleContentToFit(content, wrapper) {
                const scaleX = wrapper.clientWidth / content.scrollWidth;
                const scaleY = wrapper.clientHeight / content.scrollHeight;
                const scale = Math.min(scaleX, scaleY, 1);          

                if (scale < 1) {
                    content.style.transform = `scale(${scale})`;
                    content.style.width = `${100 / scale}%`;
                    content.style.height = `${100 / scale}%`;
                } else {
                    content.style.transform = 'scale(1)';
                    content.style.width = '100%';
                    content.style.height = '100%';
                }
            },

// Main actions
            updateSlide() {
    this.createConfirmModal(
        'Warning',
        'Are you sure you want to update? This will re-apply the industry templates while maintaining your customer\'s current licensing and opportunities.',
        'Update',
        'var(--primary)',
        () => {
// Re-apply industry templates
            this.handleIndustryChange();

// Re-apply the original customer data on top
            if (this.state.originalCustomerData) {
                const data = this.state.originalCustomerData;

// Set licensed modules
                if (data.licensed) {
                    data.licensed.forEach(module => this.matchAndSetModuleClass(module, 'licensed'));
                }
 
// Set opportunity modules
                if (data.opportunities) {
                    data.opportunities.forEach(module => this.matchAndSetModuleClass(module, 'consideration'));
                }

// Set 3rd party modules
                if (data.thirdParty) {
                    data.thirdParty.forEach(module => this.matchAndSetModuleClass(module, 'third-party'));
                }
            }

            this.updatePanels();
        },
        'var(--primary)' // Blue color for "Warning" text
    );
},

            resetSlide() {
    this.createConfirmModal(
        'Warning',
        'Are you sure you want to reset? This will clear industry template selections and restore the original customer data.',
        'Reset',
        'var(--red)',
        () => {
// Reset all modules to available first
            document.querySelectorAll('.module').forEach(m => {
                m.className = 'module available';
            });
          
// Restore customer header information if it exists
            if (this.state.originalCustomerData) {
                document.getElementById('customerTitle').textContent = `NetSuite License Analysis: ${this.state.originalCustomerData.customerName}`;
                document.getElementById('edition').textContent = this.state.originalCustomerData.edition;
                document.getElementById('serviceTier').textContent = this.state.originalCustomerData.serviceTier;
                document.getElementById('licenseCount').textContent = this.state.originalCustomerData.users;
            }

// Clear industry template selections
            ['socialImpact', 'services', 'healthcare', 'international'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.checked = false;
            });

// Restore original customer data if it exists
            if (this.state.originalCustomerData) {
                const data = this.state.originalCustomerData;

// Set licensed modules
                if (data.licensed) {
                    data.licensed.forEach(module => this.matchAndSetModuleClass(module, 'licensed'));
                }

// Set opportunity modules
                if (data.opportunities) {
                    data.opportunities.forEach(module => this.matchAndSetModuleClass(module, 'consideration'));
                }

// Set 3rd party modules
                if (data.thirdParty) {
                    data.thirdParty.forEach(module => this.matchAndSetModuleClass(module, 'third-party'));
                }               

// Restore custom solutions
                if (data.customSolutions) {
                    this.state.customSolutions = JSON.parse(JSON.stringify(data.customSolutions));
                }
            } else {
                // If no original data, set default licensed modules
                ['CRM', 'SuiteAnalytics Workbooks'].forEach(text => {
                    document.querySelectorAll('.module').forEach(m => {
                        if (m.textContent.trim() === text) m.className = 'module licensed';
                    });
                });
            }

            if (this.state.thirdPartyExpanded) this.updateThirdPartyPanel();
            if (this.state.evaluationExpanded) this.updateEvaluationPanel();
        }
    );
},

            matchAndSetModuleClass(moduleName, className) {
    let matched = false;
    document.querySelectorAll('.module').forEach(module => {
        const moduleText = module.textContent.trim();
        if (moduleText === moduleName) {
            console.log(`âœ“ MATCHED: "${moduleText}" === "${moduleName}" -> setting to ${className}`);
            module.className = `module ${className}`;
            matched = true;
        }
    });
    if (!matched) {
        console.log(`âŒ NO MATCH for "${moduleName}" - checking all modules...`);
        document.querySelectorAll('.module').forEach(module => {
            console.log(`  Available: "${module.textContent.trim()}"`);
        });
    }
},

            showSystemsMap() {
                const customerName = document.getElementById('customerTitle').textContent.replace('NetSuite License Analysis: ', '');
                const content = this.generateSystemsMapHTML();
                this.createModal(`Systems Integration Map: ${customerName}`, content);
            },

            showCalendar() {
    const customerName = document.getElementById('customerTitle').textContent.replace('NetSuite License Analysis: ', '');
    const content = this.generateCalendarHTML(true); // true = for modal
    this.createModal(`Evaluation Timeline: ${customerName}`, content);
},
getModuleDescription(moduleName) {
    const descriptions = {
        'CRM': 'Centralizing constituent relationships, providing a unified view of interactions and enabling more personalized engagement strategies.',
        'Advanced Financials': 'Delivering sophisticated financial management capabilities with enhanced reporting and compliance features for complex organizational needs.',
        'Advanced Electronic Bank Payments': 'Streamlining payment processing with secure, automated bank transfers that reduce manual intervention and improve cash flow management.',
        'Fixed Assets Management': 'Tracking and managing your equipment and facility assets with automated depreciation calculations and comprehensive audit trails.',
        'Planning + Budgeting': 'Enabling strategic financial planning with collaborative budgeting tools and scenario modeling to support informed decision-making.',
        'SuiteAnalytics Connect': 'Providing real-time business intelligence and custom reporting capabilities that transform your data into actionable insights.',
        'SuiteAnalytics Workbooks': 'Providing real-time business intelligence and custom reporting capabilities that transform your data into actionable insights.',
        'Inventory Management': 'Optimizing supply and inventory tracking with real-time visibility into stock levels and automated reordering capabilities.',
        'Advanced Manufacturing': 'Streamlining production operations with sophisticated planning tools that forecast demand and optimize resource allocation.',
        'Demand Planning': 'Forecasting future demand and optimizing inventory levels with advanced planning algorithms and scenario modeling.',
        'Bill Capture': 'Automating invoice data entry through OCR technology, reducing manual processing time by up to 80% and minimizing data entry errors in accounts payable.',
        'Procurement': 'Streamlining requisition-to-pay processes, providing better control over spending and vendor relationships.',
        'Intelligent Payment Automation': 'Streamlining vendor payment workflows with automated approval routing and scheduled payments, improving working capital management and strengthening vendor relationships.',
        'Dunning': 'Automating collections management with systematic payment reminders and escalation workflows, improving cash flow while maintaining positive customer relationships.',
        'SuiteCommerce': 'Establishing an integrated eCommerce platform connected directly to your ERP, enabling online transactions with real-time inventory visibility and seamless order fulfillment.',
        'Compliance360': 'Managing regulatory compliance, risk assessments, and policy management in a centralized platform to meet industry-specific requirements.',
        'Revenue Management': 'Ensuring proper revenue recognition across diverse funding sources including grants, donations, contracts, and service fees.',
        'Project Management': 'Tracking initiatives, programs, and operational improvement projects with integrated financial visibility and resource management.',
        'Analytics Warehouse': 'Providing advanced data warehousing capabilities for complex analytics, enabling historical trend analysis and outcome tracking across multiple dimensions.',
        'SuitePeople HR': 'Centralizing employee records, time-off management, and HR workflows to streamline people operations.',
        'Incentive Compensation': 'Automating commission calculations and incentive payouts to ensure accuracy and transparency.',
        'Payroll': 'Processing employee and contractor payments with automated tax calculations and compliance.',
        'Performance Management': 'Streamlining goal setting, feedback, and performance reviews to drive employee growth.',
        'Workforce Management': 'Coordinating schedules, time tracking, and labor compliance for efficient workforce operations.',
        'OneWorld': 'Managing global operations with multi-currency, multi-subsidiary, and multi-language capabilities.',
        'Multi-Book': 'Maintaining parallel accounting books for different standards like GAAP, IFRS, or tax reporting.',
        'SuiteTax': 'Automating complex tax calculations and compliance across multiple jurisdictions.',
        'Account Reconciliation': 'Automating account reconciliations to accelerate month-end close and improve accuracy.',
        'Close Management': 'Standardizing and automating the financial close process with consolidated reporting.',
        'Rebate Management': 'Automating rebate calculations, accruals, and payments with real-time visibility.',
        'Revenue Allocations': 'Automating revenue allocation across bundled products and services for complex contracts.',
        'Contract Renewals': 'Managing contract lifecycles with automated renewals and compliance tracking.',
        'e-invoicing': 'Ensuring compliance with country-specific e-invoicing mandates while automating invoice delivery.',
        'NetSuite Pay': 'Accepting and reconciling customer payments seamlessly within NetSuite.',
        'SuiteBilling': 'Automating subscription and usage-based billing for recurring revenue models.',
        'SuitePayments': 'Processing payments securely with support for credit cards, ACH, and digital wallets.',
        'Field Service': 'Managing field operations with scheduling, dispatch, and mobile work order management.',
        'SuiteProjects': 'Unifying project management, resource allocation, time tracking, and billing.',
        'SuiteProjects Pro': 'Coordinating complex project lifecycles with integrated budgeting, resource allocation, time tracking, and financial visibility across your organization.',
        'Corporate Tax': 'Automating corporate tax calculations, compliance, and filing requirements.',
        'Narrative Reporting': 'Creating financial reports with narrative commentary and collaborative workflows.',
        'eCommerce Connector': 'Integrating NetSuite with leading ecommerce platforms for unified operations.',
        'POS Connector': 'Syncing point-of-sale data with NetSuite for real-time inventory and sales visibility.',
        'SuiteCommerce Advanced': 'Building highly customized ecommerce experiences with advanced APIs and design tools.',
        'SuiteCommerce InStore': 'Bringing ecommerce capabilities to the sales floor with cloud-based POS.',
        'Connector': 'Integrating third-party applications with NetSuite for seamless data flow.',
        'Order Management': 'Automating order lifecycle from capture through fulfillment and returns.',
        'Grid Order Management': 'Streamlining bulk ordering for products with multiple attributes like size and color.',
        'Warehouse Management': 'Automating warehouse operations with mobile barcode scanning and real-time inventory.',
        'Smart Count': 'Automating cycle counting to maintain accurate inventory without disruption.',
        'Logistics Connector': 'Integrating with shipping providers and 3PLs for automated fulfillment.',
        'CPQ': 'Configuring complex products, pricing, and generating quotes automatically.',
        'Quality Management': 'Automating quality inspections and tracking nonconformance on the shop floor.',
        'WIP + Routings': 'Tracking production status through every manufacturing stage in real-time.',
        'Work Orders': 'Managing work orders and assemblies to coordinate production activities.',
        'ACS': 'Providing proactive system health monitoring and expert NetSuite guidance.',
        'AI Consulting': 'Delivering strategic AI implementation support and optimization services.',
        'Disaster Recovery': 'Ensuring business continuity with advanced backup and rapid restoration.',
        'LCS': 'Offering comprehensive NetSuite training through self-paced courses and workshops.',
        'Support - Premium': 'Providing 24/7 expert support with priority case handling and faster response.',
        'NSIP': 'Connecting all business applications with seamless data integration.',
        'Sandbox': 'Testing changes safely in an isolated copy of your production environment.',
        'SuiteCloud+': 'Unlocking higher API limits and advanced integration capabilities.'
    };
    return descriptions[moduleName] || 'Enhancing operational capabilities and business efficiency.';
},
parseNetSuiteReport(htmlContent) {
    const parser = new DOMParser();
    const doc = parser.parseFromString(htmlContent, 'text/html');
    const companyName = doc.querySelector('.report-subtitle')?.textContent || 'Customer';
    const licensedModules = [];
    const infrastructureModules = [];
    doc.querySelectorAll('.module.licensed').forEach(el => {
        const moduleName = el.textContent.trim();
        if (['ACS', 'LCS', 'Support - Premium', 'Sandbox'].includes(moduleName)) {
            infrastructureModules.push(moduleName);
        } else {
            licensedModules.push(moduleName);
        }
    });

    const commonModules = [];
    doc.querySelectorAll('.module.common').forEach(el => {
        commonModules.push(el.textContent.trim());
    });

    const integrations = {
    integrated: [],
    integratedManual: [],
    manual: [],
    noDataShared: []
};

const systemsMapMatch = htmlContent.match(/<h2>Systems Integration Map<\/h2>[\s\S]*?(?=<div class="report-section">|<\/body>)/);

if (systemsMapMatch) {
    const systemsMapContent = systemsMapMatch[0];

    const integratedMatch = systemsMapContent.match(/Integrated with NetSuite<\/div>([\s\S]*?)(?=<div style="position: absolute; top: 3%; right|<div style="position: absolute; bottom: 3%; left)/);
    if (integratedMatch) {
        const sectionContent = integratedMatch[1];
        const systemBlocks = [...sectionContent.matchAll(/<div style="margin-bottom: 0\.6rem[^>]*>([\s\S]*?)<\/div>\s*(?=<div style="margin-bottom: 0\.6rem|$)/g)];   

        for (const block of systemBlocks) {
            const blockContent = block[1];
            const systemMatch = blockContent.match(/font-size:\s*0\.75rem[^>]*>([^<]+)</);
            const vendorMatch = blockContent.match(/font-size:\s*0\.65rem[^>]*>([^<]+)</);          

            if (systemMatch && vendorMatch) {
                integrations.integrated.push({ system: systemMatch[1].trim(), vendor: vendorMatch[1].trim() });
            }
        }
    }

        const intManualMatch = systemsMapContent.match(/Integrated \+ Manual<\/div>([\s\S]*?)(?=<div style="position: absolute; bottom: 3%; right|<div style="position: absolute; bottom: 3%; left)/);
    if (intManualMatch) {
        const sectionContent = intManualMatch[1];
        const systemBlocks = [...sectionContent.matchAll(/<div style="margin-bottom: 0\.6rem[^>]*>([\s\S]*?)<\/div>\s*(?=<div style="margin-bottom: 0\.6rem|$)/g)];
       
        for (const block of systemBlocks) {
            const blockContent = block[1];
            const systemMatch = blockContent.match(/font-size:\s*0\.75rem[^>]*>([^<]+)</);
            const vendorMatch = blockContent.match(/font-size:\s*0\.65rem[^>]*>([^<]+)</);            

            if (systemMatch && vendorMatch) {
                integrations.integratedManual.push({ system: systemMatch[1].trim(), vendor: vendorMatch[1].trim() });
            }
        }
    }

        const manualMatch = systemsMapContent.match(/>Manual<\/div>([\s\S]*?)(?=<div style="position: absolute; bottom: 3%; right|$)/);
    if (manualMatch) {
        const sectionContent = manualMatch[1];
        const systemBlocks = [...sectionContent.matchAll(/<div style="margin-bottom: 0\.6rem[^>]*>([\s\S]*?)<\/div>\s*(?=<div style="margin-bottom: 0\.6rem|$)/g)];
    
        for (const block of systemBlocks) {
            const blockContent = block[1];
            const systemMatch = blockContent.match(/font-size:\s*0\.75rem[^>]*>([^<]+)</);
            const vendorMatch = blockContent.match(/font-size:\s*0\.65rem[^>]*>([^<]+)</);
            
            if (systemMatch && vendorMatch) {
                integrations.manual.push({ system: systemMatch[1].trim(), vendor: vendorMatch[1].trim() });
            }
        }
    }

// Try a simpler approach - just look for the last positioned box
const disconnectedMatch = systemsMapContent.match(/>No Data Shared<\/div>[\s\S]*$/);
if (disconnectedMatch) {
    const fullMatch = disconnectedMatch[0];
    // Extract all system/vendor pairs from this section
    const systemMatches = [...fullMatch.matchAll(/font-size:\s*0\.75rem[^>]*>([^<]+)<\/div>\s*<div[^>]*font-size:\s*0\.65rem[^>]*>([^<]+)</g)];

    for (const match of systemMatches) {
        integrations.noDataShared.push({ system: match[1].trim(), vendor: match[2].trim() });
    }
}
}

    const timeline = [];
    const monthBoxPattern = /<div[^>]*font-size: 1\.1rem[^>]*>([A-Za-z]+ \d{4})<\/div>([\s\S]*?)(?=<div[^>]*font-size: 1\.1rem|$)/g;
    const monthBoxes = [...htmlContent.matchAll(monthBoxPattern)];

    monthBoxes.forEach((box) => {
        const month = box[1];
        const boxContent = box[2];
        const modulePattern = /font-size: 0\.75rem[^>]*>([^<]+)<\/span>/g;
        const modules = [...boxContent.matchAll(modulePattern)];
        modules.forEach(moduleMatch => {
            const moduleName = moduleMatch[1].trim();
            if (moduleName) {
                timeline.push({ month: month, module: moduleName });
            }
        });
    });

    const noTimelineModules = [];

    return { companyName, licensedModules, infrastructureModules, commonModules, integrations, timeline, noTimelineModules };
},
exportReport() {
    const customerName = document.getElementById('customerTitle').textContent.replace('NetSuite License Analysis: ', '');
    const edition = document.getElementById('edition').textContent;
    const serviceTier = document.getElementById('serviceTier').textContent;
    const licenseCount = document.getElementById('licenseCount').textContent;

// First generate the base report
    const baseReportHTML = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NetSuite Analysis Report - ${customerName}</title>
<style>
    @page { 
        size: letter landscape; 
        margin: 0.4in; 
    }
   
    * {
        -webkit-print-color-adjust: exact !important; 
        print-color-adjust: exact !important;
        box-sizing: border-box;
    }
  
    body { 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif; 
        margin: 0; 
        padding: 0;
        background: white;
        font-size: 10pt;
        line-height: 1.4;
    }

.report-section { 
    background: white; 
    margin: 0;
    padding: 0.5in 1in;
    page-break-after: always; 
    page-break-inside: avoid;
}  
    .report-section:last-child { 
        page-break-after: auto; 
    }

    .report-title { 
        font-size: 24pt; 
        font-weight: bold; 
        color: #36677D; 
        margin-bottom: 8pt; 
    }


    .report-subtitle { 
        font-size: 14pt; 
        color: #666; 
        margin-bottom: 20pt; 
    }

    h2 { 
        color: #36677D; 
        border-bottom: 2pt solid #36677D; 
        padding-bottom: 8pt; 
        margin-top: 0;
        margin-bottom: 16pt;
        font-size: 18pt;
    }


    p {
        margin-bottom: 10pt;
        line-height: 1.5;
        font-size: 10pt;
    }

/* Executive Summary Styles */
    .executive-summary-content h1 { 
        color: #36677D; 
        font-size: 14pt; 
        margin-bottom: 8pt; 
        border-bottom: 1.5pt solid #36677D; 
        padding-bottom: 6pt; 
        margin-top: 16pt; 
        page-break-after: avoid;
    }

    .executive-summary-content h1:first-of-type { 
        margin-top: 0; 
    }

    .executive-summary-content .module-grid { 
    display: grid; 
    grid-template-columns: repeat(2, 1fr); 
    gap: 8pt; 
    margin: 10pt 0; 
    page-break-inside: avoid;
    max-width: 90%;
    font-size: 9pt;
}

    .executive-summary-content .module-box { 
    background: #F5FAFC; 
    border-left: 3pt solid #36677D; 
    padding: 8pt; 
    border-radius: 3pt;
    page-break-inside: avoid;
}

    .executive-summary-content .module-title { 
        color: #36677D; 
        font-weight: 700; 
        font-size: 10pt; 
        margin-bottom: 6pt; 
    }

    .executive-summary-content .module-content { 
        font-size: 9pt; 
        color: #555; 
        line-height: 1.4;
    }

    .executive-summary-content .integration-grid { 
    display: grid; 
    grid-template-columns: repeat(2, 1fr); 
    gap: 8pt; 
    margin: 10pt 0; 
    max-width: 88%;
}

    .executive-summary-content .integration-box { 
        background: #F8F9FA; 
        border: 2pt solid #86B596; 
        padding: 10pt; 
        border-radius: 4pt;
        page-break-inside: avoid;
    }

    .executive-summary-content .integration-box.both { 
        border-color: #E2C06B; 
        background: #FFEDD5; 
    }

    .executive-summary-content .integration-box.manual { 
        border-color: #FF8675; 
        background: #FFF5F3; 
    }

    .executive-summary-content .integration-box.gap { 
        border-color: #9CA3AF; 
        background: #F3F4F6; 
    }

    .executive-summary-content .integration-header { 
        font-weight: 700; 
        font-size: 10pt; 
        color: #264759; 
        margin-bottom: 6pt; 
        display: flex; 
        align-items: center; 
        gap: 6pt; 
    }

    .executive-summary-content .integration-status { 
        display: inline-block; 
        padding: 2pt 6pt; 
        border-radius: 3pt; 
        font-size: 8pt; 
        font-weight: 600; 
    }

    .executive-summary-content .status-integrated { 
        background: #86B596; 
        color: white; 
    }

    .executive-summary-content .status-both { 
        background: #E2C06B; 
        color: #264759; 
    }

    .executive-summary-content .status-manual { 
        background: #FF8675; 
        color: white; 
    }
  
    .executive-summary-content .status-gap { 
        background: #606988; 
        color: white; 
    }

    .executive-summary-content .integration-details { 
        font-size: 9pt; 
        color: #555; 
        margin-top: 6pt; 
        line-height: 1.4;
    }
   
    .executive-summary-content .timeline-grid { 
        display: grid; 
        grid-template-columns: repeat(3, 1fr); 
        gap: 6pt; 
        margin: 10pt 0; 
        max-width: 88%;
    }
    
    .executive-summary-content .timeline-box { 
        background: #F5FAFC; 
        border: 2pt solid #36677D; 
        padding: 10pt; 
        border-radius: 4pt;
        page-break-inside: avoid;
    }
    
    .executive-summary-content .timeline-month { 
        font-weight: 700; 
        color: #36677D; 
        font-size: 10pt; 
        margin-bottom: 8pt; 
        text-align: center; 
        border-bottom: 1pt solid #E7F2F5; 
        padding-bottom: 6pt; 
    }
    
    .executive-summary-content .timeline-item { 
        font-size: 9pt; 
        color: #264759; 
        font-weight: 600; 
        margin-bottom: 6pt; 
    }    

    .executive-summary-content .timeline-value { 
        font-size: 8pt; 
        color: #666; 
        line-height: 1.3;
    }
    
    .executive-summary-content ul { 
        margin: 10pt 0; 
        padding-left: 20pt; 
    }

    .executive-summary-content li { 
        margin-bottom: 8pt; 
        font-size: 10pt;
        page-break-inside: avoid;
    }

    .executive-summary-content .closing { 
        background: #36677D; 
        color: white; 
        padding: 16pt; 
        border-radius: 4pt; 
        text-align: center; 
        font-size: 10pt; 
        margin-top: 20pt; 
        font-weight: 500;
        page-break-inside: avoid;
    }
  
/* License Analysis specific styles */
    .modules-row { 
        display: grid; 
        gap: 6pt; 
        margin-bottom: 8pt;
        page-break-inside: avoid;
    }

    .modules-row.five-columns { 
        grid-template-columns: repeat(5, 1fr); 
    }

    .category { 
        border: 1pt solid #E7F2F5; 
        border-radius: 3pt; 
        overflow: hidden;
        page-break-inside: avoid;
    }

    .category-title { 
        background: #36677D; 
        color: white; 
        padding: 6pt; 
        font-size: 10pt; 
        font-weight: 700; 
        text-align: center; 
    }

    .modules { 
        padding: 4pt; 
        display: flex; 
        flex-direction: column; 
        gap: 3pt; 
    }

    .module { 
        padding: 4pt; 
        border-radius: 2pt; 
        font-size: 8pt; 
        font-weight: 600; 
        text-align: center; 
        border: 1pt solid; 
    }

    .available { 
        background: #F8F9FA; 
        color: #555555; 
        border-color: #CCCCCC; 
    }


    .licensed { 
        background: #6BA1B6; 
        color: #1a1a1a; 
        border-color: #6BA1B6; 
    }

    .common { 
        background: #86B596; 
        color: #1a1a1a; 
        border-color: #86B596; 
    }

    .consideration { 
        background: #E2C06B; 
        color: #1a1a1a; 
        border-color: #E2C06B; 
    }

    .third-party { 
        background: #606988; 
        color: #1a1a1a; 
        border-color: #606988; 
    }

    img {
        max-width: 100%;
        height: auto;
    }
</style>
</head>
<body>
    <div class="report-section">
        <div class="report-title">NetSuite Analysis Report</div>
        <div class="report-subtitle">${customerName}</div>
        <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
    </div>

    <div class="report-section">
        <h2>License Analysis</h2>
        <div style="background: #F5FAFC; padding: 0.75rem 1rem; border-radius: 4px; margin-bottom: 1.5rem; border-left: 4px solid #36677D;">
            <span style="font-size: 0.85rem; color: #36677D; font-weight: 600;">Edition:</span> <span style="font-size: 0.85rem; color: #555;">${edition}</span>
            <span style="margin: 0 1rem; color: #ccc;">|</span>
            <span style="font-size: 0.85rem; color: #36677D; font-weight: 600;">Service Tier:</span> <span style="font-size: 0.85rem; color: #555;">${serviceTier}</span>
            <span style="margin: 0 1rem; color: #ccc;">|</span>
            <span style="font-size: 0.85rem; color: #36677D; font-weight: 600;">Full License Users:</span> <span style="font-size: 0.85rem; color: #555;">${licenseCount}</span>
        </div>
        ${this.generateLicenseAnalysisHTML()}
    </div>

 <div class="report-section" style="page-break-after: auto;">
    <h2>Systems Integration Map</h2>
    ${this.generateSystemsMapHTMLForExport()}
</div>

<div class="report-section" style="page-break-before: auto;">
    <h2>Evaluation Timeline</h2>
    ${this.generateCalendarHTML()}
</div>
</body>
</html>`;

// Collect integration data directly from app state
const integrations = {
    integrated: [],
    integratedManual: [],
    manual: [],
    noDataShared: []
};

// Process modules marked as third-party
document.querySelectorAll('.module.third-party').forEach(module => {
    const purpose = module.textContent.trim(); // e.g., "Procurement"
    const solutionInput = this.state.thirdPartySolutions[purpose] || '';
    const hasIntegrated = this.state.thirdPartySolutions[purpose + '_integrated'];
    const hasManual = this.state.thirdPartySolutions[purpose + '_manual'];

// Parse: "Coupa (API)" -> vendor="Coupa", connector="API"
    let vendor = solutionInput;
    let connector = null;
    const match = solutionInput.match(/^(.+?)\s*\((.+?)\)\s*$/);
    if (match) {
        vendor = match[1].trim();
        connector = match[2].trim();
    }

    const integration = { vendor, purpose, connector };

    if (hasIntegrated && hasManual) integrations.integratedManual.push(integration);
    else if (hasIntegrated) integrations.integrated.push(integration);
    else if (hasManual) integrations.manual.push(integration);
    else integrations.noDataShared.push(integration);
});

// Process custom solutions
this.state.customSolutions.forEach(sol => {
    const purpose = sol.title || 'Other';
    const solutionInput = sol.name || '';  

    let vendor = solutionInput;
    let connector = null;
    const match = solutionInput.match(/^(.+?)\s*\((.+?)\)\s*$/);
    if (match) {
        vendor = match[1].trim();
        connector = match[2].trim();
    }

    const integration = { vendor, purpose, connector };

    if (sol.integrated && sol.manual) integrations.integratedManual.push(integration);
    else if (sol.integrated) integrations.integrated.push(integration);
    else if (sol.manual) integrations.manual.push(integration);
    else integrations.noDataShared.push(integration);
});

// Now parse the base report for other data
    const data = this.parseNetSuiteReport(baseReportHTML);
    data.integrations = integrations;  // Override with correct integration data

// Generate timeline data
    const today = new Date();
    const threeMonthsOut = new Date(today);
    threeMonthsOut.setMonth(threeMonthsOut.getMonth() + 3);
   
    const timelineByMonth = {};
    data.timeline.forEach(item => {
        if (!timelineByMonth[item.month]) {
            timelineByMonth[item.month] = [];
        }
        timelineByMonth[item.month].push(item.module);
    });
  
    const upcomingTimeline = data.timeline.filter(item => {
        const [monthName, year] = item.month.split(' ');
        const monthIndex = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'].indexOf(monthName);
        const itemDate = new Date(parseInt(year), monthIndex, 1);
        return itemDate >= today && itemDate <= threeMonthsOut;
    });

// Generate the complete report with executive summary
    const completeReportHTML = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NetSuite Analysis Report - ${data.companyName}</title>
    <style>
        @page { size: landscape; margin: 0.5in; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif; margin: 0; padding: 20px; background: #F1EFED; }
        .report-section { background: white; margin-bottom: 40px; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); page-break-after: always; page-break-inside: avoid; }
        h2 { color: #36677D; border-bottom: 2px solid #36677D; padding-bottom: 10px; margin-top: 0; }
        @media print { 
            @page { size: landscape; margin: 0; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            body { background: white; padding: 0; margin: 0; }
            .report-section { page-break-after: always; page-break-inside: avoid; margin: 0; padding: 15px; box-shadow: none; }
        }
        .executive-summary-content h1 { color: #36677D; font-size: 1.5rem; margin-bottom: 0.5rem; border-bottom: 2px solid #36677D; padding-bottom: 0.5rem; margin-top: 1.5rem; }
        .executive-summary-content h1:first-of-type { margin-top: 0; }
        .executive-summary-content p { margin-bottom: 1rem; line-height: 1.6; }
        .executive-summary-content .module-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.25rem; margin: 1.5rem 0; }
        .executive-summary-content .module-box { background: #F5FAFC; border-left: 4px solid #36677D; padding: 1rem; border-radius: 4px; }
        .executive-summary-content .module-title { color: #36677D; font-weight: 700; font-size: 0.95rem; margin-bottom: 0.5rem; }
        .executive-summary-content .module-content { font-size: 0.9rem; color: #555; }
        .executive-summary-content .integration-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.25rem; margin: 1.5rem 0; }
        .executive-summary-content .integration-box { background: #F0FDF4; border: 2px solid #86B596; padding: 1rem; border-radius: 6px; }
        .executive-summary-content .integration-box.both { border-color: #E2C06B; background: #FFEDD5; }
        .executive-summary-content .integration-box.manual { border-color: #FF8675; background: #FFF5F3; }
        .executive-summary-content .integration-box.gap { border-color: #606988; background: #F3F4F6; }
        .executive-summary-content .integration-header { font-weight: 700; font-size: 0.95rem; color: #264759; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
        .executive-summary-content .integration-status { display: inline-block; padding: 0.15rem 0.5rem; border-radius: 3px; font-size: 0.75rem; font-weight: 600; }
        .executive-summary-content .status-integrated { background: #86B596; color: white; }
        .executive-summary-content .status-manual { background: #FF8675; color: white; }
        .executive-summary-content .status-gap { background: #606988; color: white; }
        .executive-summary-content .status-both { background: #825E00; color: white; }
        .executive-summary-content .integration-details { font-size: 0.85rem; color: #555; margin-top: 0.5rem; }
        .executive-summary-content .timeline-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin: 1.5rem 0; }
        .executive-summary-content .timeline-box { background: #F5FAFC; border: 2px solid #36677D; padding: 1rem; border-radius: 6px; }
        .executive-summary-content .timeline-month { font-weight: 700; color: #36677D; font-size: 0.9rem; margin-bottom: 0.75rem; text-align: center; border-bottom: 1px solid #E7F2F5; padding-bottom: 0.5rem; }
        .executive-summary-content .timeline-item { font-size: 0.85rem; color: #264759; font-weight: 600; margin-bottom: 0.5rem; }
        .executive-summary-content .timeline-value { font-size: 0.8rem; color: #666; line-height: 1.4; }
        .executive-summary-content ul { margin: 1rem 0; padding-left: 1.5rem; }
        .executive-summary-content li { margin-bottom: 0.75rem; font-size: 0.95rem; }
        .executive-summary-content .closing { background: #36677D; color: white; padding: 1.5rem; border-radius: 6px; text-align: center; font-size: 1rem; margin-top: 2.5rem; font-weight: 500; }
    </style>
</head>
<body>
   <div style="background: white; color: #36677D; padding: 0.5in 0 0.2in 0;">
    <div style="max-width: 95%; margin: 0 auto; padding-left: 0.4in; padding-right: 0.5in;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
  <h1 style="margin: 0; padding: 0; border: none;">NetSuite Annual Business Review</h1>
  <div style="font-size: 1rem; font-weight: 400; margin-top: 0.15rem; opacity: 0.8;">${data.companyName}</div>
</div>
          <img src="./oracle-netsuite-logo.png" alt="NetSuite Logo" style="height: 40px;" />
        </div>
        <div style="padding-top: 0.4rem; border-top: 1px solid rgba(54, 103, 125, 0.3); font-size: 0.7rem; color: #666;">
            <p style="margin: 0;"><strong>Generated:</strong> ${new Date().toLocaleDateString()}</p>
        </div>
    </div>
</div>

    <div class="executive-summary-content" style="page-break-after: avoid; max-width: 95%; margin: 0 auto;">
<h1 style="page-break-after: avoid;">Executive Summary</h1>
            <p>Thank you for taking the time to meet with us for your annual business review. We appreciate the opportunity to discuss how NetSuite continues to support ${data.companyName}'s critical mission and explore ways we can enhance this support through technology that drives operational excellence. Please don't hesitate to reach out with questions or to discuss any aspect of this summary in greater detail.</p>

            <h1 style="page-break-after: avoid;">Current State Overview</h1>
            <p>Your NetSuite instance is actively supporting key business functions across your organization. Here's how your licensed modules are delivering value:</p>

            <div class="module-grid">
                ${data.licensedModules.map(m => `<div class="module-box"><div class="module-title">${m}</div><div class="module-content">${this.getModuleDescription(m)}</div></div>`).join('')}
                ${data.infrastructureModules.length > 0 ? `<div class="module-box"><div class="module-title">Infrastructure & Support</div><div class="module-content">Your ${data.infrastructureModules.length > 1 ? data.infrastructureModules.slice(0, -1).join(', ') + ', and ' + data.infrastructureModules[data.infrastructureModules.length - 1] : data.infrastructureModules[0]} provide${data.infrastructureModules.length === 1 ? 's' : ''} enterprise-grade reliability, testing capabilities, and expert guidance to ensure optimal system performance.</div></div>` : ''}
            </div>

            ${data.integrations.integrated.length || data.integrations.integratedManual.length || data.integrations.manual.length || data.integrations.noDataShared.length ? `
            <h1 style="page-break-before: always; page-break-after: avoid; padding-top: 0.5in; margin-top: 0;">Integration Landscape</h1>
            <p>Your NetSuite instance connects with several key business systems that extend its functionality:</p>
            <div class="integration-grid">
                ${data.integrations.integrated.map(int => `<div class="integration-box"><div class="integration-header"><span>${int.vendor}</span><span class="integration-status status-integrated">Integrated</span></div><div class="integration-details"><strong>Purpose:</strong> ${int.purpose}${int.connector ? `<br/><strong>Integration:</strong> ${int.connector}` : ''}<br/>Fully integrated with NetSuite via API. Transaction data flows automatically into NetSuite, providing real-time financial visibility and reducing reconciliation time.</div></div>`).join('')}
${data.integrations.integratedManual.map(int => `<div class="integration-box both"><div class="integration-header"><span>${int.vendor}</span><span class="integration-status status-both">Integrated + Manual</span></div><div class="integration-details"><strong>Purpose:</strong> ${int.purpose}${int.connector ? `<br/><strong>Integration:</strong> ${int.connector}` : ''}<br/>Partially integrated with some manual processes. While some data flows automatically, manual intervention is still required for certain operations. <strong>âš ï¸ Recommended for review to identify automation opportunities.</strong></div></div>`).join('')}
${data.integrations.manual.map(int => `<div class="integration-box manual"><div class="integration-header"><span>${int.vendor}</span><span class="integration-status status-manual">Manual Process</span></div><div class="integration-details"><strong>Purpose:</strong> ${int.purpose}${int.connector ? `<br/><strong>Integration:</strong> ${int.connector}` : ''}<br/>Currently requires full manual data transfer between systems. This creates reconciliation challenges, increases risk of data entry errors, and adds administrative overhead. <strong>âš ï¸ Flagged for integration review - automating this integration could save significant time and improve accuracy.</strong></div></div>`).join('')}
${data.integrations.noDataShared.map(int => `<div class="integration-box gap"><div class="integration-header"><span>${int.vendor}</span><span class="integration-status status-gap">No Data Shared</span></div><div class="integration-details"><strong>Purpose:</strong> ${int.purpose}${int.connector ? `<br/><strong>Integration:</strong> ${int.connector}` : ''}<br/>Operating as a standalone system with no data exchange with NetSuite. This creates data silos and limits visibility. <strong>âš ï¸ While the disconnect may be intentional, it's worth reviewing to determine if an integration would provide value through unified reporting.</strong></div></div>`).join('')}
            </div>` : ''}

            ${data.commonModules.length > 0 ? `
            <h1 style="page-break-before: always; page-break-after: avoid; padding-top: 0.5in; margin-top: 0;">Industry Considerations</h1>
            <p>Organizations in your industry commonly leverage several additional NetSuite modules that could benefit your operations:</p>
            <div class="module-grid">
                ${data.commonModules.map(m => `<div class="module-box"><div class="module-title">${m === 'Intelligent Payment Automation' ? m + ' (Free SuiteApp)' : m}</div><div class="module-content">${this.getModuleDescription(m)}</div></div>`).join('')}
            </div>` : ''}

            ${Object.keys(timelineByMonth).length > 0 ? `
            <h1 style="page-break-before: always; page-break-after: avoid; padding-top: 0.5in; margin-top: 0;">Evaluation Roadmap</h1>
            <p>You've identified modules for evaluation over the coming year. Here's the timeline with expected business value:</p>
            <div class="timeline-grid">
                ${Object.entries(timelineByMonth).map(([month, modules]) => `
                  <div class="timeline-box">
                    <div class="timeline-month">${month}</div>
                    ${modules.map(module => `
                      <div style="margin-bottom: 0.75rem;">
                        <div class="timeline-item">${module}</div>
                        <div class="timeline-value">${this.getModuleDescription(module)}</div>
                      </div>
                    `).join('')}
                  </div>
                `).join('')}
            </div>` : ''}
            ${data.noTimelineModules.length > 0 ? `<p style="margin-top: 1.5rem;"><strong>Additional Priority:</strong> ${data.noTimelineModules.join(', ')} evaluation is also under consideration, though no specific timeline has been set.</p>` : ''}

            <h1 style="page-break-after: avoid;">Recommended Next Steps</h1>
            <ul>
                ${upcomingTimeline.slice(0, 2).map((item, i) => `<li><strong>${item.module} ${i === 0 ? 'Implementation' : 'Planning'}:</strong> ${i === 0 ? 'Schedule a detailed scoping session' : 'Begin requirements gathering'} for the ${item.month} rollout to ensure smooth deployment and maximize ROI from day one.</li>`).join('')}
                ${data.commonModules.length > 0 ? `<li><strong>Industry Module Review:</strong> Schedule a discovery session to evaluate commonly used modules like ${data.commonModules.slice(0, 2).join(' and ')} based on your specific operational needs.</li>` : ''}
                ${data.integrations.manual.length || data.integrations.integratedManual.length ? `<li><strong>Integration Assessment:</strong> Conduct a technical review of integration opportunities to quantify potential time savings and accuracy improvements.</li>` : ''}
                <li><strong>${data.licensedModules.includes('ACS') ? 'Account Manager + Support Team Collaboration' : 'Account Manager Collaboration'}:</strong> Establish regular touchpoints to monitor module adoption, review system performance, and adjust the roadmap as priorities evolve.</li>
            </ul>
        </div>
    </div>
</div>

    <div class="report-section">
    <div style="max-width: 95%; margin: 0 auto;">
        <h2 style="padding-top: 0.25in; margin-top: 0;">License Analysis</h2>
    </div>
        <div style="background: #F5FAFC; padding: 0.75rem 1rem; border-radius: 4px; margin-bottom: 1.5rem; border-left: 4px solid #36677D; max-width: 95%; margin-left: auto; margin-right: auto;">
            <span style="font-size: 0.85rem; color: #36677D; font-weight: 600;">Edition:</span> <span style="font-size: 0.85rem; color: #555;">${edition}</span>
            <span style="margin: 0 1rem; color: #ccc;">|</span>
            <span style="font-size: 0.85rem; color: #36677D; font-weight: 600;">Service Tier:</span> <span style="font-size: 0.85rem; color: #555;">${serviceTier}</span>
            <span style="margin: 0 1rem; color: #ccc;">|</span>
            <span style="font-size: 0.85rem; color: #36677D; font-weight: 600;">Full License Users:</span> <span style="font-size: 0.85rem; color: #555;">${licenseCount}</span>
        </div>
        ${this.generateLicenseAnalysisHTML()}
    </div>

    <div class="report-section" style="page-break-after: avoid;">
    <div style="max-width: 95%; margin: 0 auto;">
        <h2 style="padding-top: 0.25in; margin-top: 0;">Systems Integration Map</h2>
    </div>
    ${this.generateSystemsMapHTMLForExport()}
</div>

<div class="report-section" style="page-break-before: avoid; page-break-after: auto;">
    <div style="max-width: 95%; margin: 0 auto;">
        <h2 style="padding-top: 0.25in; margin-top: 0;">Evaluation Timeline</h2>
    </div>
    ${this.generateCalendarHTML()}
</div>
</body>
</html>`; 

// Open in new window and trigger print dialog
    const printWindow = window.open('', '_blank');
    printWindow.document.write(completeReportHTML);
    printWindow.document.close();

// Wait for content to load, then print
    printWindow.onload = function() {
        setTimeout(() => {
            printWindow.print();
        }, 500);
    };
},
            generateLicenseAnalysisHTML() {
                const modulesAreaClone = document.querySelector('.modules-area').cloneNode(true);
                return `
                    <style>
                        .modules-row { display: grid; gap: 0.4rem; margin-bottom: 0.6rem; }
                        .modules-row.five-columns { grid-template-columns: repeat(5, 1fr); }
                        .modules-row.middle-row { grid-template-columns: repeat(5, 1fr); }
                        .category { border: 1px solid #E7F2F5; border-radius: 4px; overflow: hidden; }
                        .category-title { background: #36677D; color: white; padding: 0.4rem; font-size: 0.rem; font-weight: 700; text-align: center; }
                        .modules { padding: 0.3rem; display: flex; flex-direction: column; gap: 0.2rem; }
                        .module { padding: 0.3rem; border-radius: 3px; font-size: 0.6rem; font-weight: 600; text-align: center; border: 1px solid; }
                        .available { background: #F8F9FA; color: #555555; border-color: #CCCCCC; }
                        .licensed { background: #6BA1B6; color: #1a1a1a; border-color: #6BA1B6; }
                        .common { background: #86B596; color: #1a1a1a; border-color: #86B596; }
                        .consideration { background: #E2C06B; color: #1a1a1a; border-color: #E2C06B; }
                        .third-party { background: #606988; color: #1a1a1a; border-color: #606988; }
                        .logo-container { display: flex; align-items: center; justify-content: center; padding: 1rem; }
                    </style>
                    ${this.generateLegendHTML()}
                    ${modulesAreaClone.outerHTML}
                `;
            },

            generateLegendHTML() {
                return `
                    <div style="background: #F5FAFC; padding: 0.4rem; border-radius: 4px; text-align: center; margin-bottom: 0.8rem;">
                        <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 0.3rem;">
                           ${[
    ['#F8F9FA', 'Available Module'],
    ['#6BA1B6', 'Currently Licensed'],
    ['#86B596', 'Common for Industry'],
    ['#E2C06B', 'Evaluating'],
    ['#606988', '3rd Party Solution']
].map(([color, label]) => `
                                <div style="display: flex; align-items: center; gap: 0.3rem; font-size: 0.65rem; font-weight: 600;">
                                    <div style="width: 14px; height: 14px; border-radius: 2px; border: 1px solid rgba(0,0,0,0.2); background: ${color};"></div>
                                    ${label}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            },

            generateSystemsMapHTML() {
    const categories = this.collectModuleCategories();
    const solutions = this.collectThirdPartySolutions();

    return `
        <div style="background: #18181b; padding: 1.5rem; border-radius: 8px;">
        ${this.generateMapLegendHTML()}
        <div style="position: relative; width: 100%; min-height: 700px;">
            <svg style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0;">
                            ${solutions.integrated.length > 0 ? '<line x1="18%" y1="15%" x2="30%" y2="40%" stroke="#86B596" stroke-width="3" stroke-dasharray="8,4"/>' : ''}
                            ${solutions.both.length > 0 ? '<line x1="82%" y1="15%" x2="70%" y2="40%" stroke="#9B59B6" stroke-width="3" stroke-dasharray="8,4"/>' : ''}
                            ${solutions.manual.length > 0 ? '<line x1="18%" y1="85%" x2="30%" y2="60%" stroke="#E2C06B" stroke-width="3" stroke-dasharray="8,4"/>' : ''}
                            ${solutions.disconnected.length > 0 ? '<line x1="82%" y1="85%" x2="70%" y2="60%" stroke="#FF8675" stroke-width="3" stroke-dasharray="8,4" opacity="0.5"/>' : ''}
                        </svg>

                        <div style="position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); background: #d1d5db; border: 2px solid #264759; border-radius: 8px; padding: 1rem; box-shadow: 0 6px 18px rgba(0,0,0,0.15); max-width: 700px; width: 65%; z-index: 2;">
                            <div style="text-align: center; margin-bottom: 0.8rem; border-bottom: 1px solid #E0E0E0; padding-bottom: 0.5rem;">
    <img src="./oracle-netsuite-logo.png" alt="NetSuite Logo" style="max-height: 35px; max-width: 150px; object-fit: contain;">
</div>
                            ${Object.entries(categories).map(([category, modules]) => `
                                <div style="margin-bottom: 0.7rem;">
                                    <div style="color: #36677D; font-size: 0.7rem; font-weight: 700; margin-bottom: 0.3rem;">${category}</div>
                                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.3rem;">
                                        ${modules.map(m => this.renderModuleBox(m)).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        ${this.renderSolutionBox(solutions.integrated, '#86B596', 'Integrated with NetSuite', 'top: 8%; left: 3%;')}
${this.renderSolutionBox(solutions.both, '#9B59B6', 'Integrated + Manual', 'top: 8%; right: 3%;')}
${this.renderSolutionBox(solutions.manual, '#E2C06B', 'Manual', 'bottom: 8%; left: 3%;')}
${this.renderSolutionBox(solutions.disconnected, '#FF8675', 'No Data Shared', 'bottom: 8%; right: 3%;')}
                    </div>
                 </div>
                `;
            },
generateSystemsMapHTMLForExport() {
    const categories = this.collectModuleCategories();
    const solutions = this.collectThirdPartySolutions();

    return `
        ${this.generateMapLegendHTML()}
        <div style="position: relative; width: 100%; min-height: 650px;">
            <svg style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0;">
                ${solutions.integrated.length > 0 ? '<line x1="15%" y1="15%" x2="32%" y2="45%" stroke="#86B596" stroke-width="3" stroke-dasharray="8,4"/>' : ''}
${solutions.both.length > 0 ? '<line x1="85%" y1="15%" x2="68%" y2="45%" stroke="#9B59B6" stroke-width="3" stroke-dasharray="8,4"/>' : ''}
${solutions.manual.length > 0 ? '<line x1="15%" y1="85%" x2="32%" y2="55%" stroke="#E2C06B" stroke-width="3" stroke-dasharray="8,4"/>' : ''}
${solutions.disconnected.length > 0 ? '<line x1="85%" y1="85%" x2="68%" y2="55%" stroke="#FF8675" stroke-width="3" stroke-dasharray="8,4" opacity="0.5"/>' : ''}
            </svg>

            <div style="position: absolute; top: 38%; left: 50%; transform: translate(-50%, -50%); background: #e5e7eb; border: 2px solid #264759; border-radius: 6px; padding: 0.5rem; box-shadow: 0 6px 18px rgba(0,0,0,0.15); max-width: 500px; width: 50%; z-index: 2;">
                <div style="text-align: center; margin-bottom: 0.4rem; border-bottom: 1px solid #E0E0E0; padding-bottom: 0.3rem;">
                    <img src="./oracle-netsuite-logo.png" alt="NetSuite Logo" style="max-height: 25px; max-width: 100px; object-fit: contain;">
                </div>
                ${Object.entries(categories).map(([category, modules]) => `
                    <div style="margin-bottom: 0.25rem;">
    <div style="color: #36677D; font-size: 0.55rem; font-weight: 700; margin-bottom: 0.1rem;">${category}</div>
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.2rem;">
                            ${modules.map(m => this.renderModuleBox(m)).join('')}
                        </div>
                    </div>
                `).join('')}
            </div>

            ${this.renderSolutionBox(solutions.integrated, '#86B596', 'Integrated with NetSuite', 'top: 8%; left: 2%;')}
${this.renderSolutionBox(solutions.both, '#9B59B6', 'Integrated + Manual', 'top: 8%; right: 2%;')}
${this.renderSolutionBox(solutions.manual, '#E2C06B', 'Manual', 'bottom: 8%; left: 2%;')}
${this.renderSolutionBox(solutions.disconnected, '#FF8675', 'No Data Shared', 'bottom: 8%; right: 2%;')}
        </div>
    `;
},

            generateMapLegendHTML() {
    return `
        <div style="background: #e5e7eb; border: 2px solid #36677D; border-radius: 6px; padding: 0.5rem 0.8rem; margin-bottom: 0.8rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); width: fit-content;">
    <div style="font-size: 0.75rem; font-weight: bold; color: #3f3f46; margin-bottom: 0.4rem;">Legend</div>
    <div style="display: grid; grid-template-columns: auto auto; gap: 0.3rem 1.5rem;">
                            ${[
                                ['<svg width="30" height="3"><line x1="0" y1="1.5" x2="30" y2="1.5" stroke="#86B596" stroke-width="3" stroke-dasharray="8,4"/></svg>', 'Integrated with NS'],
                                ['<div style="width: 20px; height: 20px; background: #4A90E2; border-radius: 3px;"></div>', 'Licensed Module'],
                                ['<svg width="30" height="3"><line x1="0" y1="1.5" x2="30" y2="1.5" stroke="#9B59B6" stroke-width="3" stroke-dasharray="8,4"/></svg>', 'Integrated + Manual'],
                                ['<div style="width: 20px; height: 20px; background: #E2C06B; border-radius: 3px;"></div>', 'Under Evaluation'],
                                ['<svg width="30" height="3"><line x1="0" y1="1.5" x2="30" y2="1.5" stroke="#E2C06B" stroke-width="3" stroke-dasharray="8,4"/></svg>', 'Manual'],
                                ['<div style="width: 20px; height: 20px; background: #F8F9FA; border: 2px solid #CCC; border-radius: 3px;"></div>', '3rd Party Solution'],
                                ['<svg width="30" height="3"><line x1="0" y1="1.5" x2="30" y2="1.5" stroke="#FF8675" stroke-width="3" stroke-dasharray="8,4" opacity="0.5"/></svg>', 'No Data Shared']
                            ].map(([icon, label]) => `
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    ${icon}
                                    <span style="font-size: 0.65rem; color: #264759;">${label}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            },

            collectModuleCategories() {
                const categories = {};
                document.querySelectorAll('.category').forEach(categoryDiv => {
                    const categoryName = categoryDiv.querySelector('.category-title').textContent.trim();
                    const modules = [];

                    categoryDiv.querySelectorAll('.module').forEach(module => {
                        const moduleName = module.textContent.trim();
                        if (module.classList.contains('licensed')) {
                            modules.push({ name: moduleName, type: 'licensed' });
                        } else if (module.classList.contains('consideration')) {
                            const priorityIndex = this.state.allEvaluationPriorities.findIndex(p => p.name === moduleName);
                            modules.push({ 
                                name: moduleName, 
                                type: 'evaluation',
                                priority: priorityIndex >= 0 ? priorityIndex + 1 : null
                            });
                        }
                    });

                    if (modules.length > 0) categories[categoryName] = modules;
                });

                const customPriorities = this.state.allEvaluationPriorities.filter(p => p.type === 'custom');
                if (customPriorities.length > 0) {
                    categories['Custom Evaluation Priorities'] = customPriorities.map((priority, idx) => ({
                        name: priority.name || 'Unnamed Priority',
                        type: 'evaluation',
                        priority: this.state.allEvaluationPriorities.indexOf(priority) + 1
                    }));
                }

                return categories;
            },

            collectThirdPartySolutions() {
                const solutions = { integrated: [], manual: [], both: [], disconnected: [] };

                document.querySelectorAll('.module.third-party').forEach(module => {
                    const moduleName = module.textContent.trim();
                    const solutionName = this.state.thirdPartySolutions[moduleName] || moduleName;
                    const hasIntegrated = this.state.thirdPartySolutions[moduleName + '_integrated'];
                    const hasManual = this.state.thirdPartySolutions[moduleName + '_manual'];
                    const solution = { name: solutionName, category: moduleName };

                    if (hasIntegrated && hasManual) solutions.both.push(solution);
                    else if (hasIntegrated) solutions.integrated.push(solution);
                    else if (hasManual) solutions.manual.push(solution);
                    else solutions.disconnected.push(solution);
                });

                
                this.state.customSolutions.forEach(solution => {
                    const sol = { 
                        name: solution.name || 'Unnamed Solution', 
                        category: solution.title || 'Other'
                    };

                    if (solution.integrated && solution.manual) solutions.both.push(sol);
                    else if (solution.integrated) solutions.integrated.push(sol);
                    else if (solution.manual) solutions.manual.push(sol);
                    else solutions.disconnected.push(sol);
                });

                return solutions;
            },

            renderModuleBox(module) {
    if (module.type === 'licensed') {
        return `<div style="background: white; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.65rem; font-weight: 600; min-height: 28px; display: flex; align-items: center; justify-content: flex-start; border-left: 3px solid #6BA1B6; color: #264759;">${module.name}</div>`;
    } else if (module.type === 'evaluation') {
        const badge = module.priority ? `<span style="background: #E2C06B; color: #264759; border-radius: 50%; width: 18px; height: 18px; line-height: 18px; display: inline-block; text-align: center; font-size: 0.65rem; margin-right: 0.3rem; font-weight: bold;">${module.priority}</span>` : '';
        return `<div style="background: white; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.65rem; font-weight: 600; min-height: 28px; display: flex; align-items: center; justify-content: flex-start; border-left: 3px solid #E2C06B; color: #264759;">${badge}${module.name}</div>`;
    }
    return '';
},

            renderSolutionBox(solutions, color, label, position) {
                if (solutions.length === 0) return '';                

                return `
    <div style="position: absolute; ${position} background: #d1d5db; border: 2px solid ${color}; border-radius: 6px; padding: 0.6rem; max-width: 220px; min-width: 200px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 1;">
                        <div style="background: ${color}; color: #3f3f46; font-size: 0.7rem; font-weight: 700; padding: 0.4rem; border-radius: 3px; margin-bottom: 0.5rem; text-align: center;">${label}</div>
                        ${solutions.map(sol => `
                            <div style="margin-bottom: 0.4rem; padding: 0.4rem; background: #F8F9FA; border-radius: 3px; border-left: 2px solid ${color};">
    <div style="font-size: 0.65rem; font-weight: 600; color: #264759; margin-bottom: 0.1rem;">${sol.category}</div>
    <div style="font-size: 0.6rem; color: #666;">${sol.name}</div>
</div>
                        `).join('')}
                    </div>
                `;
            },

            generateCalendarHTML(isModal = false) {
                const now = new Date();
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                const months = Array.from({ length: 12 }, (_, i) => {
                    const date = new Date(now.getFullYear(), now.getMonth() + i, 1);
                    return { name: monthNames[date.getMonth()], year: date.getFullYear(), index: i };
                });

                const wrapperBg = isModal ? '#18181b' : '#f9fafb';
                const monthBoxBg = isModal ? '#d1d5db' : '#ffffff';
                const monthPriorities = Array(12).fill(null).map(() => []);
                const noPriorities = [];

                this.state.allEvaluationPriorities.forEach((priority, index) => {
                    const timelineMap = { 'ASAP': 0, '3mo.': 3, '3-6mo.': 6, '6mo+': 11 };
                    const targetMonth = timelineMap[priority.timeline];

                    if (targetMonth !== undefined) {
                        monthPriorities[targetMonth].push({ number: index + 1, name: priority.name });
                    } else if (!priority.timeline) {
                        noPriorities.push({ number: index + 1, name: priority.name });
                    }
                });

                return `
    <div style="background: ${wrapperBg}; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem;">
        ${months.map((month, idx) => {
            const priorities = monthPriorities[idx];
            const hasItems = priorities.length > 0;
            return `
                <div style="background: ${monthBoxBg}; border: 2px solid ${hasItems ? '#36677D' : '#d1d5db'}; border-radius: 8px; padding: 1rem; height: 200px; display: flex; flex-direction: column;">
                                    <div style="font-size: 1.1rem; font-weight: bold; color: #36677D; margin-bottom: 0.75rem; text-align: center; border-bottom: 1px solid #E7F2F5; padding-bottom: 0.5rem;">${month.name} ${month.year}</div>
                                    <div style="display: flex; flex-direction: column; gap: 0.5rem; flex: 1; overflow-y: auto;">
                                        ${priorities.map(item => `
                                            <div style="background: white; padding: 0.5rem; border-radius: 4px; border: 1px solid #d1d5db; display: flex; align-items: center; gap: 0.4rem;">
                                                <span style="background: #E2C06B; color: #264759; border-radius: 50%; width: 20px; height: 20px; line-height: 20px; font-size: 0.65rem; text-align: center; font-weight: bold; flex-shrink: 0;">${item.number}</span>
                                                <span style="font-size: 0.75rem; font-weight: 600; color: #36677D;">${item.name}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    ${noPriorities.length > 0 ? `
    <div style="background: ${monthBoxBg}; border: 2px solid #E2C06B; border-radius: 8px; padding: 1.5rem;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #6b7280; margin-bottom: 1rem; text-align: center;">No Timeline Indicated</div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 0.75rem;">
                                ${noPriorities.map(item => `
                                    <div style="background: white; padding: 0.75rem; border-radius: 6px; border: 1px solid #E2C06B; display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="background: #E2C06B; color: #264759; border-radius: 50%; width: 24px; height: 24px; line-height: 24px; font-size: 0.7rem; text-align: center; font-weight: bold; flex-shrink: 0;">${item.number}</span>
                                        <span style="font-size: 0.85rem; font-weight: 600; color: #264759;">${item.name}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                `;
            }
        };

// Initialize
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.module').forEach(m => {
                const text = m.textContent.trim();
                m.className = ['CRM', 'SuiteAnalytics Workbooks'].includes(text) ? 'module licensed' : 'module available';
            });

            const scaleToFit = () => {
    const container = document.querySelector('.scale-container');
    if (!container) return;
    const scaleX = window.innerWidth / 1600;
    const scaleY = window.innerHeight / 768;
    const scale = Math.min(scaleX, scaleY);
    container.style.transform = `scale(${scale})`;
    container.style.transformOrigin = 'top left';
};

            scaleToFit();
            window.addEventListener('resize', scaleToFit);


            setTimeout(() => app.matchPanelHeights(), 100);
            window.addEventListener('resize', () => setTimeout(() => app.matchPanelHeights(), 50));
        });

// Listen for customer data from parent window
        console.log('Setting up message listener in license analyzer');
        window.addEventListener('message', (event) => {
            console.log('License analyzer received message:', event.data);

            if (event.data.type === 'CUSTOMER_DATA') {
    console.log('Processing CUSTOMER_DATA:', event.data);

// Populate header directly
    document.getElementById('customerTitle').textContent = `NetSuite License Analysis: ${event.data.customerName}`;
    document.getElementById('edition').textContent = event.data.edition;
    document.getElementById('serviceTier').textContent = event.data.serviceTier;
    document.getElementById('licenseCount').textContent = event.data.users;

// Parse the original customer data
    const licensedModules = event.data.licensed ? event.data.licensed.split(',').map(m => m.trim()).filter(Boolean) : [];
    const opportunityModules = event.data.opportunities ? event.data.opportunities.split(',').map(m => m.trim()).filter(Boolean) : [];

// Apply industry template if nonprofit
    if (event.data.isNonprofit) {
        console.log('Applying Social Impact template');
        document.getElementById('socialImpact').checked = true;
        app.handleIndustryChange();
    }

// Set licensed modules
    if (event.data.licensed) {
        console.log('Licensed modules:', licensedModules);
        licensedModules.forEach(moduleName => {
            app.matchAndSetModuleClass(moduleName, 'licensed');
        });
    }

// Set opportunity modules
    if (event.data.opportunities) {
        console.log('Opportunity modules:', opportunityModules);
        opportunityModules.forEach(moduleName => {
            app.matchAndSetModuleClass(moduleName, 'consideration');
        });
    }

// Handle custom solutions
    if (event.data.customSolutions) {
        console.log('Processing custom solutions:', event.data.customSolutions);
        app.state.customSolutions = event.data.customSolutions;

// Mark modules as third-party if their name matches a solution's Purpose
    event.data.customSolutions.forEach(solution => {
        if (solution.title) {
            // Check if any module matches this purpose
            document.querySelectorAll('.module').forEach(module => {
                const moduleName = module.textContent.trim();
                // Only mark as third-party if not already licensed or under evaluation
                if (moduleName.toLowerCase() === solution.title.toLowerCase() && 
                    !module.classList.contains('licensed') && 
                    !module.classList.contains('consideration')) {
                    module.classList.remove('available', 'common');
                    module.classList.add('third-party');
                }
            });
        }
    });
}

    app.updatePanels();
    // Populate evaluation priorities immediately for calendar
const evaluationModules = Array.from(document.querySelectorAll('.module.consideration'))
    .map(m => m.textContent.trim());

evaluationModules.forEach(module => {
    if (!app.state.allEvaluationPriorities.find(p => p.type === 'module' && p.name === module)) {
        app.state.allEvaluationPriorities.push({ type: 'module', name: module });
    }
});
    // Store original data after everything is set up
    // Collect 3rd party modules that might have been marked
    const thirdPartyModules = [];
    document.querySelectorAll('.module.third-party').forEach(m => {
        thirdPartyModules.push(m.textContent.trim());
    });

    app.state.originalCustomerData = {
    customerName: event.data.customerName,
    edition: event.data.edition,
    serviceTier: event.data.serviceTier,
    users: event.data.users,
    licensed: licensedModules,
    opportunities: opportunityModules,
    thirdParty: thirdPartyModules,
    customSolutions: event.data.customSolutions ? JSON.parse(JSON.stringify(event.data.customSolutions)) : [],
    isNonprofit: event.data.isNonprofit
};

// Try to restore saved state (but NOT module states - those come from notes app)
const savedStateKey = 'licenseAnalyzerState_' + event.data.customerName;
const savedState = localStorage.getItem(savedStateKey);
if (savedState) {
    try {
        const state = JSON.parse(savedState);
        console.log('Restoring saved state for:', event.data.customerName);
        
        app.state.thirdPartySolutions = state.thirdPartySolutions || {};
        app.state.customSolutions = state.customSolutions || [];
        app.state.allEvaluationPriorities = state.allEvaluationPriorities || [];
        
        // Restore industry template selections
        if (state.industryTemplates) {
            if (state.industryTemplates.socialImpact) {
                document.getElementById('socialImpact').checked = true;
            }
            if (state.industryTemplates.services) {
                document.getElementById('services').checked = true;
            }
            if (state.industryTemplates.healthcare) {
                document.getElementById('healthcare').checked = true;
            }
            if (state.industryTemplates.international) {
                document.getElementById('international').checked = true;
            }
            
            // Reapply the templates
            app.handleIndustryChange();
            
            // **NEW: Re-apply customer data on top of templates**
            licensedModules.forEach(moduleName => {
                app.matchAndSetModuleClass(moduleName, 'licensed');
            });
            
            opportunityModules.forEach(moduleName => {
                app.matchAndSetModuleClass(moduleName, 'consideration');
            });
            
            thirdPartyModules.forEach(moduleName => {
                app.matchAndSetModuleClass(moduleName, 'third-party');
            });

// **ADD THIS NEW BLOCK HERE:**
// Restore manually changed module states
// Only restore 'consideration' and 'third-party' (user choices)
// Don't restore 'licensed' or 'common' (those come from customer data/templates)
if (state.moduleStates) {
    Object.keys(state.moduleStates).forEach(moduleName => {
        const savedState = state.moduleStates[moduleName];
        // Only restore user-modified states
        if (savedState === 'consideration' || savedState === 'third-party') {
            app.matchAndSetModuleClass(moduleName, savedState);
        }
    });
}
// **END OF NEW BLOCK**
        }
        
        app.updatePanels();
    } catch (error) {
        console.error('Error restoring state:', error);
    }
}
            }

            if (event.data.type === 'THIRD_PARTY_SYNC_FROM_NOTES') {
                console.log('Received third party sync from notes app:', event.data);

                // Store current checkbox states before clearing
const savedIntegrationStates = {};
Object.keys(app.state.thirdPartySolutions).forEach(key => {
    if (key.endsWith('_integrated') || key.endsWith('_manual')) {
        savedIntegrationStates[key] = app.state.thirdPartySolutions[key];
    }
});

// Clear existing third-party states
document.querySelectorAll('.module.third-party').forEach(module => {
    module.classList.remove('third-party');
    module.classList.add('available');
});

// Clear existing data
app.state.thirdPartySolutions = {};
app.state.customSolutions = [];

// Restore checkbox states
Object.keys(savedIntegrationStates).forEach(key => {
    app.state.thirdPartySolutions[key] = savedIntegrationStates[key];
});

 // Process solutions from notes app
                if (event.data.solutions) {
                    event.data.solutions.forEach(solution => {
                        // Check if this matches an existing module
                        let matchedModule = false;
                        document.querySelectorAll('.module').forEach(module => {
                            const moduleName = module.textContent.trim();
                            if (moduleName.toLowerCase() === solution.purpose.toLowerCase()) {
                                // Mark module as third-party
                                module.classList.remove('available', 'licensed', 'common', 'consideration');
                                module.classList.add('third-party');

                                // Store solution data
                                const fullName = solution.connectorName ? 
                                    `${solution.solutionName} (${solution.connectorName})` : 
                                    solution.solutionName;
                                app.state.thirdPartySolutions[moduleName] = fullName;


                                // Set checkboxes
                                if (solution.connectedToNS === 'both') {
                                    app.state.thirdPartySolutions[moduleName + '_integrated'] = true;
                                    app.state.thirdPartySolutions[moduleName + '_manual'] = true;
                                } else if (solution.connectedToNS === 'integrated') {
                                    app.state.thirdPartySolutions[moduleName + '_integrated'] = true;
                                } else if (solution.connectedToNS === 'manual') {
                                    app.state.thirdPartySolutions[moduleName + '_manual'] = true;
                                }
                         
                                matchedModule = true;
                            }
                        });


                        // If no match, add as custom solution
                        if (!matchedModule && solution.purpose) {
                            const fullName = solution.connectorName ? 
                                `${solution.solutionName} (${solution.connectorName})` : 
                                solution.solutionName;

                            app.state.customSolutions.push({
                                title: solution.purpose,
                                name: fullName,
                                integrated: solution.connectedToNS === 'both' || solution.connectedToNS === 'integrated',
                                manual: solution.connectedToNS === 'both' || solution.connectedToNS === 'manual'
                            });
                        }
                    });
                }

                app.updatePanels();
                app.saveState();
            }
        if (event.data.type === 'OPPORTUNITIES_SYNC_FROM_NOTES') {
        console.log('Received opportunities sync from notes app:', event.data);

        // Get all current consideration modules
        const currentConsiderationModules = Array.from(document.querySelectorAll('.module.consideration'))
            .map(m => m.textContent.trim());

        // This sync is FROM analyzer TO notes, so we only remove analyzer-sourced opportunities
const u = { ...selectedCustomer };
if (!u.data.modules) u.data.modules = [];

// Get list of opportunity names from analyzer
const analyzerOpportunityNames = event.data.opportunities.map(opp => opp.name);

// Remove opportunities that came from analyzer and are no longer in the list
u.data.modules = u.data.modules.filter(m => {
  // Keep everything that's not an analyzer-sourced opportunity
  if (m.status !== 'Opportunity' || m.source !== 'analyzer') return true;

  // For analyzer opportunities, only keep if still in the list
  return analyzerOpportunityNames.includes(m.name);
});

u.lastEdited = new Date().toISOString().split('T')[0];
setSelectedCustomer(u);
setCustomers(prev => prev.map(c => c.id === u.id ? u : c)); 

        app.updatePanels();
        app.saveState();
    }
});
    </script>
</body>
</html>